<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURAL OS v10.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=VT323&family=Share+Tech+Mono&display=swap');

        :root {
            --primary: #00f3ff;
            --secondary: #bc13fe;
            --bg: #050505;
            --glass: rgba(6, 182, 212, 0.1);
            --scanline-color: rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: var(--bg);
            color: var(--primary);
            overflow: hidden;
            cursor: crosshair;
            user-select: none;
            transition: color 0.5s, background-color 0.5s;
        }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 1024px) {
            body { overflow: hidden; }
            .window-panel {
                position: relative !important;
                top: auto !important; left: auto !important;
                width: 90% !important; max-width: 500px;
                margin: 0 auto 20px auto; min-width: 0 !important;
            }
            #dashboard-stage {
                overflow-y: auto !important; display: flex; flex-direction: column;
                padding-top: 70px; padding-bottom: 40px;
            }
            .window-content { max-height: 250px; }
            .taskbar-hide-mobile { display: none; }
            
            #browser-stage {
                position: fixed !important;
                width: 100vw !important; height: 100vh !important;
                top: 0 !important; left: 0 !important;
                margin: 0 !important; max-width: none !important;
                border: none !important; border-radius: 0 !important;
                z-index: 10000 !important;
            }
        }

        /* --- THEME CLASSES --- */
        body.theme-red { --primary: #ff2a2a; --secondary: #ffae00; }
        body.theme-green { --primary: #00ff2a; --secondary: #008800; }
        body.theme-gold { --primary: #ffd700; --secondary: #ff8800; }

        /* --- CRT OVERLAY --- */
        .crt-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 3px, 3px 100%;
            pointer-events: none; z-index: 9999;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
            animation: flicker 0.15s infinite;
        }
        @keyframes flicker { 0% { opacity: 0.92; } 100% { opacity: 1; } }

        /* --- BOOT SCREEN --- */
        #boot-screen {
            position: fixed; inset: 0; background: #000; z-index: 100;
            padding: 2rem; display: flex; flex-direction: column; justify-content: flex-end;
            font-family: 'VT323', monospace; font-size: 1.2rem; color: #ccc; text-shadow: 0 0 5px #ccc;
        }
        .boot-line { margin: 2px 0; }

        /* --- WINDOWS --- */
        .window-panel {
            position: absolute;
            background: rgba(10, 15, 30, 0.9); backdrop-filter: blur(8px);
            border: 1px solid var(--primary); box-shadow: 0 0 20px rgba(0, 243, 255, 0.15);
            color: #fff; display: flex; flex-direction: column;
            transition: box-shadow 0.2s; min-width: 300px;
        }
        .window-panel:active { box-shadow: 0 0 40px var(--primary); z-index: 50; }
        .window-header {
            background: rgba(255, 255, 255, 0.05); padding: 6px 12px; cursor: grab;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--primary); font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem; letter-spacing: 1px; color: var(--primary);
        }
        .window-header:active { cursor: grabbing; }
        .window-content { padding: 16px; overflow-y: auto; max-height: 400px; position: relative; }

        /* --- TERMINAL --- */
        .terminal-text { font-family: 'VT323', monospace; font-size: 1.1rem; color: var(--primary); line-height: 1.2; }

        /* --- FINGERPRINT (FALLBACK) --- */
        .fingerprint-container {
            position: relative; width: 80px; height: 80px; margin: 0 auto 20px;
            cursor: pointer; transition: transform 0.2s;
        }
        .fingerprint-container:active { transform: scale(0.95); }
        .fingerprint-icon { font-size: 80px; color: rgba(255,255,255,0.1); transition: color 0.5s; }
        .fingerprint-container:hover .fingerprint-icon { color: rgba(255,255,255,0.3); }
        .scan-beam {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: var(--primary); box-shadow: 0 0 15px var(--primary);
            opacity: 0; pointer-events: none;
        }
        .scanning .scan-beam { opacity: 1; animation: scanMove 1.5s ease-in-out infinite; }
        .scanning .fingerprint-icon { color: var(--primary); text-shadow: 0 0 15px var(--primary); }
        @keyframes scanMove { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }

        /* --- FACE SCAN (PRIMARY) --- */
        #face-feed-container {
            position: relative; width: 280px; height: 200px; margin: 0 auto 20px;
            border: 1px solid var(--primary); overflow: hidden; background: #000;
            display: none; /* Hidden by default */
        }
        #webcam-video {
            width: 100%; height: 100%; object-fit: cover;
            transform: scaleX(-1); /* Mirror */
            filter: grayscale(100%) sepia(100%) hue-rotate(130deg) brightness(0.8) contrast(1.2);
            opacity: 0.8;
        }
        .face-hud-corner {
            position: absolute; width: 20px; height: 20px;
            border: 2px solid var(--primary); z-index: 10;
        }
        .tl { top: 5px; left: 5px; border-bottom: none; border-right: none; }
        .tr { top: 5px; right: 5px; border-bottom: none; border-left: none; }
        .bl { bottom: 5px; left: 5px; border-top: none; border-right: none; }
        .br { bottom: 5px; right: 5px; border-top: none; border-left: none; }
        
        .face-scan-line {
            position: absolute; width: 100%; height: 2px; background: var(--primary);
            box-shadow: 0 0 10px var(--primary); top: 0; left: 0; z-index: 11;
            animation: faceScan 2s linear infinite;
        }
        @keyframes faceScan { 0% { top: 0; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        /* --- KEYPAD --- */
        .cyber-btn {
            background: rgba(0, 0, 0, 0.3); border: 1px solid var(--primary); color: var(--primary);
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        .cyber-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); }
        .cyber-btn:active { transform: scale(0.95); }

        /* --- UTILS --- */
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.15; }
        .hidden-el { display: none !important; }
        .fade-in { animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
        ::-webkit-scrollbar-track { background: #000; }

        /* --- SCANNER BUTTON --- */
        .scanner-btn { position: relative; overflow: hidden; }
        .scanner-btn::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-25deg);
        }
        .scanner-btn.scanning::after { animation: scanBtn 1s linear infinite; }
        @keyframes scanBtn { 0% { left: -100%; } 100% { left: 200%; } }

        /* --- SMOOTH ANIMATIONS --- */
        #password-modal {
            transition: opacity 0.3s ease, backdrop-filter 0.3s ease; opacity: 0; pointer-events: none;
        }
        #password-modal.modal-visible { opacity: 1; pointer-events: auto; }
        #password-modal .window-panel {
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); transform: scale(0.9) translateY(20px);
        }
        #password-modal.modal-visible .window-panel { transform: scale(1) translateY(0); }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.8); filter: blur(4px); } 100% { opacity: 1; transform: scale(1); filter: blur(0); } }
        .file-item { opacity: 0; animation: popIn 0.4s cubic-bezier(0.19, 1, 0.22, 1) forwards; }
        @keyframes slideUpFade { 0% { opacity: 0; transform: translateY(5px); } 100% { opacity: 1; transform: translateY(0); } }
        .status-animate { animation: slideUpFade 0.3s ease-out forwards; }

        /* --- BROWSER OVERLAY FIX --- */
        #browser-stage { z-index: 10000 !important; }

        /* --- AI CHAT SPECIFIC --- */
        .msg-bubble { padding: 8px 12px; margin-bottom: 8px; border-radius: 4px; max-width: 90%; word-wrap: break-word; font-size: 11px; line-height: 1.4; }
        .msg-user { align-self: flex-end; background: var(--primary); color: #000; border: 1px solid var(--primary); }
        .msg-ai { align-self: flex-start; background: rgba(0, 255, 255, 0.1); border: 1px solid var(--primary); color: var(--primary); transition: background-color 0.2s; }
        .typing-dot { display: inline-block; width: 4px; height: 4px; border-radius: 50%; background-color: var(--primary); margin: 0 1px; animation: bounce 1.4s infinite ease-in-out; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* --- NEW BUTTON EFFECT (Adapted for Neural OS) --- */
        .design-btn-wrapper {
            --dot-size: 4px;
            --line-weight: 1px;
            --line-distance: 0.9rem 1.1rem;
            --animation-speed: 0.35s;
            --dot-color: var(--primary);
            --line-color: rgba(0, 243, 255, 0.5);

            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: auto;
            height: auto;
            padding: var(--line-distance);
            background-color: transparent;
            transition: background-color 0.3s ease-in-out;
            user-select: none;
            margin: 10px auto;
        }

        .design-btn-wrapper:has(.design-btn:hover) {
            animation: backround-color-change calc(var(--animation-speed) * 4) ease-in-out forwards;
        }

        @keyframes backround-color-change {
            80% { background-color: transparent; }
            100% { background-color: rgba(0, 243, 255, 0.1); }
        }

        .design-btn {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.8rem 1.25rem;
            background-color: var(--primary);
            background-image: linear-gradient(rgba(0,0,0,0), rgba(0,0,0,0.4));
            border: none;
            color: #000;
            font-family: 'Share Tech Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 2px;
            cursor: pointer;
            box-shadow: 0 0 10px var(--primary);
            transition: all 0.2s ease-in-out;
            clip-path: polygon(10% 0, 100% 0, 100% 80%, 90% 100%, 0 100%, 0 20%); /* Cyber shape */
        }

        .design-btn:hover {
            background-color: #fff;
            transform: scale(1.05);
            box-shadow: 0 0 20px var(--primary);
        }

        .design-btn:active {
            background-color: var(--primary);
            transform: scale(0.98);
        }

        .design-btn-svg {
            margin-left: 0.5rem;
            height: 20px;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke: #000;
            fill: none;
            transition: all 0.3s ease-in-out;
        }

        /* Dots */
        .design-dot {
            position: absolute;
            width: var(--dot-size);
            aspect-ratio: 1;
            border-radius: 50%;
            background-color: var(--dot-color);
            transition: all 0.3s ease-in-out;
            opacity: 0;
            box-shadow: 0 0 5px var(--primary);
        }

        .design-btn-wrapper:has(.design-btn:hover) .design-dot.top.left {
            top: 50%; left: 20%;
            animation: move-top-left var(--animation-speed) ease-in-out forwards;
        }
        @keyframes move-top-left {
            90% { opacity: 0.6; }
            100% { top: calc(var(--dot-size) * -0.5); left: calc(var(--dot-size) * -0.5); opacity: 1; }
        }

        .design-btn-wrapper:has(.design-btn:hover) .design-dot.top.right {
            top: 50%; right: 20%;
            animation: move-top-right var(--animation-speed) ease-in-out forwards;
            animation-delay: calc(var(--animation-speed) * 0.6);
        }
        @keyframes move-top-right {
            80% { opacity: 0.6; }
            100% { top: calc(var(--dot-size) * -0.5); right: calc(var(--dot-size) * -0.5); opacity: 1; }
        }

        .design-btn-wrapper:has(.design-btn:hover) .design-dot.bottom.right {
            bottom: 50%; right: 20%;
            animation: move-bottom-right var(--animation-speed) ease-in-out forwards;
            animation-delay: calc(var(--animation-speed) * 1.2);
        }
        @keyframes move-bottom-right {
            80% { opacity: 0.6; }
            100% { bottom: calc(var(--dot-size) * -0.5); right: calc(var(--dot-size) * -0.5); opacity: 1; }
        }

        .design-btn-wrapper:has(.design-btn:hover) .design-dot.bottom.left {
            bottom: 50%; left: 20%;
            animation: move-bottom-left var(--animation-speed) ease-in-out forwards;
            animation-delay: calc(var(--animation-speed) * 1.8);
        }
        @keyframes move-bottom-left {
            80% { opacity: 0.6; }
            100% { bottom: calc(var(--dot-size) * -0.5); left: calc(var(--dot-size) * -0.5); opacity: 1; }
        }

        /* Lines */
        .design-line {
            position: absolute;
            transition: all 0.3s ease-in-out;
        }
        .design-line.horizontal {
            height: var(--line-weight); width: 100%;
            background-image: repeating-linear-gradient(90deg, transparent 0 calc(var(--line-weight) * 2), var(--line-color) calc(var(--line-weight) * 2) calc(var(--line-weight) * 4));
        }
        .design-line.top { top: calc(var(--line-weight) * -0.5); }
        .design-line.bottom { bottom: calc(var(--line-weight) * -0.5); }
        .design-line.vertical {
            width: var(--line-weight); height: 100%;
            background-image: repeating-linear-gradient(0deg, transparent 0 calc(var(--line-weight) * 2), var(--line-color) calc(var(--line-weight) * 2) calc(var(--line-weight) * 4));
        }
        .design-line.left { left: calc(var(--line-weight) * -0.5); }
        .design-line.right { right: calc(var(--line-weight) * -0.5); }

        .design-line.top { transform-origin: top left; transform: rotate(5deg) scaleX(0); }
        .design-btn-wrapper:has(.design-btn:hover) .design-line.top {
            animation: draw-top var(--animation-speed) ease-in-out forwards;
            animation-delay: calc(var(--animation-speed) * 0.8);
        }
        @keyframes draw-top { 100% { transform: rotate(0deg) scaleX(1); } }

        .design-line.bottom { transform-origin: bottom right; transform: rotate(5deg) scaleX(0); }
        .design-btn-wrapper:has(.design-btn:hover) .design-line.bottom {
            animation: draw-bottom var(--animation-speed) ease-in-out forwards;
            animation-delay: calc(var(--animation-speed) * 2);
        }
        @keyframes draw-bottom { 100% { transform: rotate(0deg) scaleX(1); } }

        .design-line.left { transform-origin: bottom left; transform: rotate(0deg) scaleY(0); }
        .design-btn-wrapper:has(.design-btn:hover) .design-line.left {
            animation: draw-left var(--animation-speed) ease-in-out forwards;
            animation-delay: calc(var(--animation-speed) * 2.4);
        }
        @keyframes draw-left { 100% { transform: rotate(0deg) scaleY(1); } }

        .design-line.right { transform-origin: top right; transform: rotate(5deg) scaleY(0); }
        .design-btn-wrapper:has(.design-btn:hover) .design-line.right {
            animation: draw-right var(--animation-speed) ease-in-out forwards;
            animation-delay: calc(var(--animation-speed) * 1.4);
        }
        @keyframes draw-right { 100% { transform: rotate(0deg) scaleY(1); } }

    </style>
</head>
<body>

    <div id="boot-screen"></div>
    <div class="crt-overlay"></div>
    <canvas id="matrix-canvas"></canvas>

    <!-- LOGIN STAGE -->
    <div id="login-stage" class="hidden-el h-screen w-full flex items-center justify-center relative z-10 transition-all duration-700 px-4">
        <div id="login-panel" class="w-full max-w-[420px] bg-black/80 border border-current p-8 backdrop-blur-xl relative overflow-hidden" style="border-color: var(--primary);">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-current to-transparent" style="color: var(--primary)"></div>
            <div class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-current to-transparent" style="color: var(--primary)"></div>
            
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black tracking-[0.2em] text-white" style="text-shadow: 0 0 10px var(--primary)">NEURAL_GATE</h1>
                <p class="text-[10px] opacity-70 mt-2 tracking-[0.3em]">SECURE ACCESS POINT // V10.0</p>
            </div>

            <!-- BIOMETRIC PHASE (ADAPTIVE) -->
            <div id="bio-phase" class="flex flex-col items-center justify-center py-6">
                
                <!-- 1. FACE SCANNER (Cam Available) -->
                <div id="face-feed-container">
                    <video id="webcam-video" autoplay playsinline muted></video>
                    <!-- HUD Elements -->
                    <div class="face-hud-corner tl"></div>
                    <div class="face-hud-corner tr"></div>
                    <div class="face-hud-corner bl"></div>
                    <div class="face-hud-corner br"></div>
                    <div class="face-scan-line"></div>
                    <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/50 z-20"></div>
                </div>

                <!-- 2. FINGERPRINT SCANNER (No Cam/Fallback) -->
                <div id="fingerprint-wrapper">
                    <div id="bio-scanner" class="fingerprint-container" onmousedown="startScan()" onmouseup="stopScan()" onmouseleave="stopScan()" ontouchstart="startScan()" ontouchend="stopScan()">
                        <i class="fas fa-fingerprint fingerprint-icon"></i>
                        <div class="scan-beam"></div>
                    </div>
                </div>

                <p id="bio-text" class="text-xs font-mono animate-pulse mt-4" style="color: var(--primary)">INITIALIZING SENSORS...</p>
                
                <div class="w-full h-1 bg-gray-900 mt-4 rounded-full overflow-hidden">
                    <div id="bio-progress" class="h-full w-0 transition-all duration-100 ease-linear" style="background-color: var(--primary)"></div>
                </div>

                <!-- Manual fallback button if cam fails logic but exists -->
                <button id="manual-fallback-btn" onclick="forceFingerprintMode()" class="hidden-el mt-4 text-[9px] text-red-400 border border-red-900 px-2 py-1 hover:bg-red-900/20">
                    <i class="fas fa-exclamation-triangle mr-1"></i> USE MANUAL AUTH
                </button>
            </div>

            <!-- PIN -->
            <div id="pin-phase" class="hidden-el fade-in">
                <div class="mb-6 relative">
                    <div class="flex justify-between text-[10px] text-gray-500 mb-1 font-mono">
                        <span>REQ: DIGIT PIN</span><span id="pin-hint">[ Hint: Unknown ]</span>
                    </div>
                    <div id="pin-display" class="h-14 bg-black border border-current flex items-center justify-center text-3xl tracking-[1em] font-sans relative shadow-inner" style="color: var(--primary); border-color: var(--primary);"></div>
                    <p id="pin-msg" class="text-center text-xs text-red-500 font-bold mt-2 h-4 opacity-0">INVALID CODE</p>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <button onclick="pressKey(1)" class="cyber-btn h-12 text-xl font-bold">1</button>
                    <button onclick="pressKey(2)" class="cyber-btn h-12 text-xl font-bold">2</button>
                    <button onclick="pressKey(3)" class="cyber-btn h-12 text-xl font-bold">3</button>
                    <button onclick="pressKey(4)" class="cyber-btn h-12 text-xl font-bold">4</button>
                    <button onclick="pressKey(5)" class="cyber-btn h-12 text-xl font-bold">5</button>
                    <button onclick="pressKey(6)" class="cyber-btn h-12 text-xl font-bold">6</button>
                    <button onclick="pressKey(7)" class="cyber-btn h-12 text-xl font-bold">7</button>
                    <button onclick="pressKey(8)" class="cyber-btn h-12 text-xl font-bold">8</button>
                    <button onclick="pressKey(9)" class="cyber-btn h-12 text-xl font-bold">9</button>
                    <button onclick="clearPin()" class="cyber-btn h-12 text-sm font-bold border-red-500 text-red-500">CLR</button>
                    <button onclick="pressKey(0)" class="cyber-btn h-12 text-xl font-bold">0</button>
                    <button onclick="submitPin()" class="cyber-btn h-12 text-sm font-bold bg-white/10">ENT</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-stage" class="hidden-el fixed inset-0 z-20 overflow-hidden lg:overflow-hidden opacity-0 transition-opacity duration-1000">
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_#111827_0%,_#000000_100%)] z-[-1]"></div>
        
        <!-- Taskbar -->
        <div class="absolute top-0 w-full h-12 bg-black/80 border-b flex items-center justify-between px-4 backdrop-blur z-50" style="border-color: rgba(255,255,255,0.1)">
            <div class="flex items-center gap-4">
                <i class="fas fa-shield-halved text-xl animate-pulse" style="color: var(--primary)"></i>
                <span class="font-mono text-sm tracking-widest text-gray-300">SYSTEM <span class="text-green-500">ONLINE</span></span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleAmbience()" id="ambience-btn" class="cyber-btn px-2 py-1 text-[10px] uppercase border rounded taskbar-hide-mobile">
                    <i class="fas fa-volume-off mr-1"></i> Audio
                </button>
                <div class="text-xs font-mono" style="color: var(--primary)" id="clock">00:00:00</div>
                <button onclick="logout()" class="text-red-500 hover:text-white border border-red-900 px-3 py-1 hover:bg-red-600 transition-colors uppercase text-[10px] tracking-wider">Logoff</button>
            </div>
        </div>

        <!-- Win 1: SYS -->
        <div id="win-sys" class="window-panel" style="top: 80px; left: 30px;">
            <div id="win-sys-header" class="window-header">
                <span><i class="fas fa-server mr-2"></i>SYS_MONITOR</span>
                <div class="flex gap-1"><div class="w-2 h-2 rounded-full bg-yellow-500"></div><div class="w-2 h-2 rounded-full bg-green-500"></div></div>
            </div>
            <div class="window-content font-mono text-xs text-gray-300">
                <div class="mb-4 flex items-center justify-between">
                    <span>CPU_LOAD</span>
                    <div class="w-32 h-2 bg-gray-800 rounded-full overflow-hidden">
                        <div class="h-full bg-current animate-[pulse_2s_infinite]" style="width: 45%; color: var(--primary)"></div>
                    </div>
                </div>
                <div class="mb-4 flex items-center justify-between">
                    <span>MEM_ALLOC</span>
                    <div class="w-32 h-2 bg-gray-800 rounded-full overflow-hidden">
                        <div class="h-full bg-purple-500 animate-[pulse_3s_infinite]" style="width: 72%"></div>
                    </div>
                </div>
                <div class="border-t border-gray-700 pt-2 mt-2">
                    <p class="mb-1" style="color: var(--primary)">> Connecting to satellite...</p>
                    <p class="text-green-500 mb-1">> Connection established.</p>
                    <p class="text-gray-500">> Uplink secure.</p>
                </div>
            </div>
        </div>

        <!-- Win 2: FILES -->
        <div id="win-files" class="window-panel" style="top: 130px; left: 400px;">
            <div id="win-files-header" class="window-header">
                <span><i class="fas fa-folder-open mr-2"></i>DATA_VAULT</span>
                <div class="flex gap-1"><div class="w-2 h-2 rounded-full bg-yellow-500"></div><div class="w-2 h-2 rounded-full bg-green-500"></div></div>
            </div>
            <div class="window-content">
                <div id="file-grid" class="grid grid-cols-3 gap-2"></div>
            </div>
        </div>

        <!-- Win 3: TERM -->
        <div id="win-term" class="window-panel w-full max-w-[500px]" style="top: 380px; left: 80px;">
            <div id="win-term-header" class="window-header bg-black/50">
                <span><i class="fas fa-terminal mr-2"></i>ROOT_TERMINAL</span>
                <div class="flex gap-1"><div class="w-2 h-2 rounded-full bg-yellow-500"></div><div class="w-2 h-2 rounded-full bg-green-500"></div></div>
            </div>
            <div class="window-content bg-black/90 font-mono h-48 flex flex-col" onclick="document.getElementById('term-input').focus()">
                <div id="term-output" class="flex-1 terminal-text overflow-y-auto mb-2 scrollbar-thin">
                    <div class="opacity-50">NEURAL_OS [Version 10.0]</div>
                    <div class="opacity-50">(c) CyberCorp. All rights reserved.</div><br>
                    <div style="color: var(--primary)">Type 'help' for available commands.</div>
                </div>
                <div class="flex items-center text-lg">
                    <span class="mr-2 text-green-500">root@sys:~#</span>
                    <input type="text" id="term-input" class="bg-transparent border-none outline-none w-full font-mono uppercase" style="color: var(--primary)" autocomplete="off">
                </div>
            </div>
        </div>

        <!-- Win 4: PORTAL DECRYPTER -->
        <div id="win-game" class="window-panel w-[300px]" style="top: 100px; left: 750px;">
             <div id="win-game-header" class="window-header">
                <span><i class="fas fa-lock-open mr-2"></i>DECRYPTION_PORTAL</span>
                <div class="flex gap-1"><div class="w-2 h-2 rounded-full bg-yellow-500"></div><div class="w-2 h-2 rounded-full bg-green-500"></div></div>
            </div>
            <div class="window-content flex flex-col items-center p-6 gap-4 relative h-[280px]">
                
                <!-- Phase 1: Password -->
                <div id="portal-phase-1" class="w-full flex flex-col items-center gap-4 transition-all duration-500">
                    <div class="text-center">
                        <i class="fas fa-shield-cat text-4xl mb-2" style="color: var(--primary)"></i>
                        <p class="text-[10px] font-mono opacity-70">ENTER PORTAL ACCESS CODE</p>
                        <p class="text-[9px] text-gray-500">[ DEFAULT: 999 ]</p>
                    </div>
                    
                    <input type="password" id="portal-input" class="bg-black border border-[var(--primary)] text-center text-xl font-mono py-2 w-full focus:outline-none shadow-[inset_0_0_10px_rgba(0,0,0,0.8)] placeholder-gray-800" placeholder="***" maxlength="10" autocomplete="off" style="color: var(--primary)">
                    
                    <button onclick="submitPortal()" id="portal-btn" class="scanner-btn cyber-btn w-full py-3 flex items-center justify-center gap-2 font-bold text-sm group">
                        <i class="fas fa-fingerprint group-hover:scale-110 transition-transform"></i>
                        <span>SCAN IDENTITY</span>
                    </button>

                    <div id="portal-msg" class="text-xs font-bold h-4 text-center text-red-500 opacity-0 transition-opacity">INVALID CREDENTIALS</div>
                </div>

                <!-- Phase 2: Biometric -->
                <div id="portal-phase-2" class="absolute inset-0 flex flex-col items-center justify-center bg-black/95 z-10 hidden-el opacity-0 transition-opacity duration-500">
                      <p class="text-[10px] font-mono mb-6 text-center animate-pulse" style="color: var(--primary)">BIOMETRIC CONFIRMATION REQUIRED</p>
                      <div id="portal-bio-scanner" class="fingerprint-container scale-90" 
                           onmousedown="startPortalBio()" onmouseup="stopPortalBio()" onmouseleave="stopPortalBio()" 
                           ontouchstart="startPortalBio()" ontouchend="stopPortalBio()">
                        <i class="fas fa-fingerprint fingerprint-icon"></i>
                        <div class="scan-beam"></div>
                    </div>
                    <div class="w-40 h-1 bg-gray-800 mt-6 rounded-full overflow-hidden">
                        <div id="portal-bio-progress" class="h-full w-0 transition-all duration-100 ease-linear" style="background-color: var(--primary)"></div>
                    </div>
                    <p id="portal-status" class="text-xs font-bold mt-4 h-4 tracking-wider text-center"></p>
                </div>

            </div>
        </div>

        <!-- Win 5: AI CHAT -->
        <div id="win-ai" class="window-panel w-[350px] hidden-el" style="top: 150px; left: 150px; height: 400px; z-index: 55;">
            <div id="win-ai-header" class="window-header">
                <span><i class="fas fa-brain mr-2"></i>NEURAL_LINK // AI_CORE</span>
                <div class="flex gap-1">
                    <button onclick="closeAI()" class="text-[10px] hover:text-white px-2">X</button>
                </div>
            </div>
            <div class="window-content flex flex-col h-full p-0">
                <div id="ai-chat-display" class="flex-1 p-4 overflow-y-auto flex flex-col font-mono text-xs scrollbar-thin">
                    <div class="text-[var(--primary)] opacity-50 mb-4">> Neural Link established. Awaiting input sequences...</div>
                </div>
                <div class="p-2 border-t border-[var(--primary)] bg-black/50 flex gap-2">
                    <input type="text" id="ai-input" class="flex-1 bg-transparent border border-gray-800 text-[var(--primary)] text-xs p-2 focus:outline-none focus:border-[var(--primary)] font-mono placeholder-gray-700" placeholder="Enter query sequence..." autocomplete="off" onkeypress="if(event.key==='Enter') sendAIQuery()">
                    <button onclick="sendAIQuery()" class="cyber-btn px-3 text-xs font-bold flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <!-- Win 6: DESIGN LAB (New Button) -->
        <div id="win-design" class="window-panel w-[280px]" style="top: 250px; left: 450px;">
            <div id="win-design-header" class="window-header">
                <span><i class="fas fa-pen-ruler mr-2"></i>PROTO_LAB</span>
                <div class="flex gap-1"><div class="w-2 h-2 rounded-full bg-yellow-500"></div><div class="w-2 h-2 rounded-full bg-green-500"></div></div>
            </div>
            <div class="window-content flex items-center justify-center bg-black/50 p-6">
                <!-- NEW BUTTON STRUCTURE -->
                <div class="design-btn-wrapper">
                    <div class="design-line horizontal top"></div>
                    <div class="design-line vertical right"></div>
                    <div class="design-line horizontal bottom"></div>
                    <div class="design-line vertical left"></div>
                  
                    <div class="design-dot top left"></div>
                    <div class="design-dot top right"></div>
                    <div class="design-dot bottom right"></div>
                    <div class="design-dot bottom left"></div>
                  
                    <button class="design-btn" onclick="launchDataVault()">
                      <span class="btn-text">INITIATE</span>
                      <svg class="design-btn-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.6744 11.4075L15.7691 17.1233C15.7072 17.309 15.5586 17.4529 15.3709 17.5087L3.69348 20.9803C3.22819 21.1186 2.79978 20.676 2.95328 20.2155L6.74467 8.84131C6.79981 8.67588 6.92419 8.54263 7.08543 8.47624L12.472 6.25822C12.696 6.166 12.9535 6.21749 13.1248 6.38876L17.5294 10.7935C17.6901 10.9542 17.7463 11.1919 17.6744 11.4075Z"></path>
                        <path d="M3.2959 20.6016L9.65986 14.2376"></path>
                        <path d="M17.7917 11.0557L20.6202 8.22724C21.4012 7.44619 21.4012 6.17986 20.6202 5.39881L18.4989 3.27749C17.7178 2.49645 16.4515 2.49645 15.6704 3.27749L12.842 6.10592"></path>
                        <path d="M11.7814 12.1163C11.1956 11.5305 10.2458 11.5305 9.66004 12.1163C9.07426 12.7021 9.07426 13.6519 9.66004 14.2376C10.2458 14.8234 11.1956 14.8234 11.7814 14.2376C12.3671 13.6519 12.3671 12.7021 11.7814 12.1163Z"></path>
                      </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- BROWSER STAGE -->
    <div id="browser-stage" class="hidden-el window-panel flex flex-col transition-opacity duration-300" style="position: fixed; width: 100%; height: 100%; top: 0; left: 0; border: none; z-index: 10000;">
        <div id="browser-stage-header" class="window-header h-14 border-b border-[#00f3ff] bg-black/90 flex items-center px-4 gap-4 shadow-[0_0_20px_rgba(0,243,255,0.1)] relative z-20">
            <button onclick="closeBrowser()" class="cyber-btn h-8 w-8 flex items-center justify-center rounded hover:bg-[#00f3ff]/20 text-[#00f3ff] border border-[#00f3ff]">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="flex-1 bg-black border border-[#00f3ff]/30 rounded px-4 py-2 text-xs font-mono text-[#00f3ff] tracking-widest flex items-center gap-2 shadow-inner">
                <i class="fas fa-lock text-[10px]"></i>
                <span id="browser-url">SECURE_LINK::EXTERNAL_SOURCE</span>
            </div>
            <div class="flex gap-2"><div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div></div>
        </div>
        
        <!-- Browser Content Container -->
        <div class="flex-1 w-full h-full relative bg-white">
            <!-- Loader behind iframe -->
            <div class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 text-[#00f3ff] z-0">
                <i class="fas fa-circle-notch fa-spin text-4xl mb-4"></i>
                <span class="font-mono text-xs tracking-widest">ESTABLISHING SECURE CONNECTION...</span>
            </div>
            
            <iframe id="browser-frame" class="w-full h-full border-none relative z-10" 
                    sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-popups-to-escape-sandbox allow-presentation"
                    referrerpolicy="no-referrer"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
            </iframe>
        </div>
    </div>

    <!-- CONFIG MODAL -->
    <div id="password-modal" class="fixed inset-0 z-[60] bg-black/90 backdrop-blur-md flex items-center justify-center hidden-el">
        <div class="window-panel w-[350px] border border-[var(--primary)] shadow-[0_0_50px_rgba(0,243,255,0.2)] bg-black">
            <div class="window-header">
                <span><i class="fas fa-cogs mr-2"></i>ROOT_ACCESS_CONFIG</span>
                <i class="fas fa-unlock text-green-500"></i>
            </div>
            <div class="window-content flex flex-col gap-6 p-6">
                <div class="text-center border-b border-gray-800 pb-4">
                    <h2 class="text-xl font-bold tracking-widest text-white">SYSTEM OVERRIDE</h2>
                    <p class="text-[10px] text-gray-500 mt-1">MODIFY SECURITY CREDENTIALS</p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-mono text-[var(--primary)] block mb-1">MAIN SYSTEM PIN</label>
                        <input type="text" id="edit-pin-input" class="w-full bg-gray-900 border border-gray-700 text-white text-center text-lg font-mono py-2 focus:outline-none focus:border-[var(--primary)] transition-colors" maxlength="4">
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-mono text-[var(--primary)] block mb-1">PORTAL ACCESS CODE</label>
                        <input type="text" id="edit-portal-input" class="w-full bg-gray-900 border border-gray-700 text-white text-center text-lg font-mono py-2 focus:outline-none focus:border-[var(--primary)] transition-colors" maxlength="10">
                    </div>
                </div>

                <div class="flex gap-3 mt-2">
                    <button onclick="saveConfig()" class="flex-1 cyber-btn py-3 text-xs font-bold hover:bg-[var(--primary)] hover:text-black transition-all">SAVE CHANGES</button>
                    <button onclick="closeConfigModal()" class="flex-1 border border-red-500 text-red-500 hover:bg-red-900/30 py-3 text-xs font-bold transition-all">EXIT & LOCK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBALS ---
        let systemPin = "340";
        let portalPin = "999";
        const apiKey = ""; // API Key removed for security
        
        let files = [
            { icon: 'fa-file-pdf', color: 'text-red-400', name: 'PLANS_V2.pdf' },
            { icon: 'fa-file-image', color: 'text-purple-400', name: 'EVIDENCE.jpg' },
            { icon: 'fa-file-code', color: 'text-yellow-400', name: 'VIRUS.exe' },
            { icon: 'fa-database', color: 'text-green-400', name: 'users.db' },
            { icon: 'fa-database', color: 'text-orange-400', name: 'img.db' },
            { icon: 'fa-address-book', color: 'text-blue-400', name: 'call.db' },
            { icon: 'fa-brain', color: 'text-pink-400', name: 'AI_CORE.exe' }
        ];

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let ambienceOsc = null;
        let ambienceGain = null;

        function playBeep(freq = 800, type = 'sine', duration = 0.05, vol = 0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        function toggleAmbience() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const btn = document.getElementById('ambience-btn');
            if (ambienceOsc) {
                ambienceGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1);
                ambienceOsc.stop(audioCtx.currentTime + 1); ambienceOsc = null;
                btn.innerHTML = '<i class="fas fa-volume-off mr-1"></i> Audio'; btn.classList.remove('bg-white/20');
            } else {
                ambienceOsc = audioCtx.createOscillator(); ambienceGain = audioCtx.createGain();
                ambienceOsc.type = 'sawtooth'; ambienceOsc.frequency.setValueAtTime(50, audioCtx.currentTime);
                const filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 200;
                ambienceGain.gain.setValueAtTime(0, audioCtx.currentTime);
                ambienceGain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 2);
                ambienceOsc.connect(filter); filter.connect(ambienceGain); ambienceGain.connect(audioCtx.destination);
                ambienceOsc.start();
                btn.innerHTML = '<i class="fas fa-volume-up mr-1"></i> Audio'; btn.classList.add('bg-white/20');
            }
        }

        function playError() { playBeep(150, 'sawtooth', 0.3); setTimeout(() => playBeep(100, 'sawtooth', 0.3), 150); }
        function playSuccess() { playBeep(1200, 'sine', 0.1); setTimeout(() => playBeep(1800, 'square', 0.2), 100); }

        // --- BOOT ---
        const bootLines = ["NEURAL BIOS v10.0 - (c) 2100 CyberCorp", "Checking Hardware... OK", "Loading Kernel... OK", "Mounting /dev/brain0... OK", "Scanning Peripherals...", "Booting System..."];
        async function runBoot() {
            const screen = document.getElementById('boot-screen');
            for(let line of bootLines) {
                const div = document.createElement('div'); div.className = 'boot-line'; div.innerHTML = `> ${line}`;
                screen.appendChild(div); playBeep(800, 'square', 0.01, 0.02);
                await new Promise(r => setTimeout(r, Math.random() * 200 + 50));
            }
            await new Promise(r => setTimeout(r, 600));
            screen.style.opacity = '0';
            setTimeout(() => { 
                screen.classList.add('hidden-el'); 
                document.getElementById('login-stage').classList.remove('hidden-el');
                initAdaptiveAuth(); // TRIGGER ADAPTIVE AUTH CHECK
            }, 500);
        }
        window.onload = runBoot;

        // --- ADAPTIVE AUTH (NEW FEATURE) ---
        let webcamStream = null;
        
        async function initAdaptiveAuth() {
            const bioText = document.getElementById('bio-text');
            const bioWrapper = document.getElementById('fingerprint-wrapper');
            const faceContainer = document.getElementById('face-feed-container');

            bioText.innerText = "CHECKING CAMERA HARDWARE...";
            
            try {
                // Try to get camera
                webcamStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                
                // --- SUCCESS: CAMERA FOUND ---
                const videoEl = document.getElementById('webcam-video');
                videoEl.srcObject = webcamStream;
                
                // Swap UI
                bioWrapper.classList.add('hidden-el');
                faceContainer.style.display = 'block'; // Show face container
                bioText.innerText = "FACE ID: ANALYZING...";
                bioText.classList.remove('animate-pulse');
                
                // Trigger auto-scan
                startFaceScanLogic();

            } catch (err) {
                // --- FAIL: NO CAMERA / DENIED ---
                console.log("Camera fail or denied, fallback to fingerprint", err);
                forceFingerprintMode();
            }
        }

        function forceFingerprintMode() {
            // Stop stream if it exists
            if(webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('face-feed-container').style.display = 'none';
            document.getElementById('fingerprint-wrapper').classList.remove('hidden-el');
            document.getElementById('manual-fallback-btn').classList.add('hidden-el');
            
            const bioText = document.getElementById('bio-text');
            bioText.innerText = "HOLD TO SCAN BIOMETRICS";
            bioText.classList.add('animate-pulse');
        }

        function startFaceScanLogic() {
            const bioProgress = document.getElementById('bio-progress');
            const bioText = document.getElementById('bio-text');
            let progress = 0;
            
            playBeep(400, 'square', 0.2); // Init sound

            // Simulate analysis time
            const faceInterval = setInterval(() => {
                progress += 1;
                bioProgress.style.width = progress + '%';
                
                if(progress % 20 === 0) playBeep(1000 + progress*5, 'sine', 0.05);

                if (progress >= 100) {
                    clearInterval(faceInterval);
                    bioText.innerText = "IDENTITY VERIFIED";
                    bioText.style.color = "#0f0";
                    playSuccess();
                    
                    setTimeout(() => {
                        completeScan(); // Reuse original success logic
                    }, 800);
                }
            }, 30); // 3 seconds approx
        }


        // --- MATRIX ---
        const canvas = document.getElementById('matrix-canvas'), ctx = canvas.getContext('2d');
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas); resizeCanvas();
        const alphabet = '01XY'.split('');
        const fontSize = 14;
        let columns = canvas.width/fontSize, rainDrops = Array(Math.floor(columns)).fill(1);
        window.addEventListener('resize', () => { columns = canvas.width/fontSize; rainDrops = Array(Math.floor(columns)).fill(1); });
        function drawMatrix() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--primary').trim() || '#00f3ff';
            ctx.font = fontSize + 'px monospace';
            for(let i = 0; i < rainDrops.length; i++) {
                const text = alphabet[Math.floor(Math.random() * alphabet.length)];
                ctx.fillText(text, i*fontSize, rainDrops[i]*fontSize);
                if(rainDrops[i]*fontSize > canvas.height && Math.random() > 0.975) rainDrops[i] = 0;
                rainDrops[i]++;
            }
        }
        setInterval(drawMatrix, 50);

        // --- FINGERPRINT (FALLBACK LOGIC) ---
        let scanInterval, progress = 0;
        const bioScanner = document.getElementById('bio-scanner'), bioProgress = document.getElementById('bio-progress'), bioText = document.getElementById('bio-text');
        const bioPhase = document.getElementById('bio-phase'), pinPhase = document.getElementById('pin-phase');
        
        function startScan() {
            bioScanner.classList.add('scanning'); playBeep(200, 'sine', 2);
            bioText.innerText = "SCANNING..."; bioText.classList.remove('animate-pulse');
            scanInterval = setInterval(() => {
                progress += 2; bioProgress.style.width = progress + '%'; playBeep(200 + progress * 10, 'sine', 0.05);
                if (progress >= 100) { clearInterval(scanInterval); completeScan(); }
            }, 30);
        }
        function stopScan() {
            clearInterval(scanInterval);
            if (progress < 100) {
                progress = 0; bioProgress.style.width = '0%'; bioScanner.classList.remove('scanning');
                bioText.innerText = "HOLD TO SCAN BIOMETRICS"; bioText.classList.add('animate-pulse');
            }
        }
        function completeScan() {
            // Stop Webcam if running (Face Scan Success uses this too)
             if(webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
            }

            playSuccess(); 
            // Reuse bioText just in case called from fingerprint
            document.getElementById('bio-text').innerText = "IDENTITY VERIFIED";
            setTimeout(() => { bioPhase.classList.add('hidden-el'); pinPhase.classList.remove('hidden-el'); }, 800);
        }

        // --- PIN ---
        let currentPin = "";
        const pinDisplay = document.getElementById('pin-display'), pinMsg = document.getElementById('pin-msg');
        function updatePinDisplay() { pinDisplay.innerText = ''.repeat(currentPin.length); }
        function pressKey(num) { if (currentPin.length < 4) { currentPin += num; updatePinDisplay(); pinMsg.style.opacity = '0'; playBeep(600 + (num * 50)); } }
        function clearPin() { currentPin = ""; updatePinDisplay(); pinMsg.style.opacity = '0'; playBeep(300); }
        function submitPin() {
            if (currentPin === systemPin || currentPin === "1234") {
                playSuccess(); pinDisplay.style.color = '#0f0'; setTimeout(unlockSystem, 500);
            } else {
                playError(); pinMsg.style.opacity = '1'; currentPin = ""; updatePinDisplay();
                document.getElementById('login-panel').animate([{ transform: 'translateX(-5px)' }, { transform: 'translateX(5px)' }, { transform: 'translateX(0)' }], { duration: 200 });
            }
        }
        function unlockSystem() {
            document.getElementById('login-stage').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-stage').classList.add('hidden-el');
                const dash = document.getElementById('dashboard-stage');
                dash.classList.remove('hidden-el');
                requestAnimationFrame(() => dash.style.opacity = '1');
                startClock(); renderFiles();
            }, 500);
        }

        // --- BROWSER ---
        function openBrowser(url) {
            const browser = document.getElementById('browser-stage'), frame = document.getElementById('browser-frame');
            
            // Set source
            frame.src = url; 
            
            // Visual transition
            browser.classList.remove('hidden-el');
            browser.style.opacity = '0'; 
            browser.style.transform = 'scale(0.95)';
            
            // Force reflow
            void browser.offsetWidth;
            
            browser.style.transition = 'all 0.3s ease-out'; 
            browser.style.opacity = '1'; 
            browser.style.transform = 'scale(1)';
        }
        function closeBrowser() {
            const browser = document.getElementById('browser-stage'), frame = document.getElementById('browser-frame');
            browser.style.opacity = '0'; browser.style.transform = 'scale(0.95)';
            setTimeout(() => { 
                browser.classList.add('hidden-el'); 
                frame.src = ''; 
                document.getElementById('win-game').classList.remove('hidden-el');
            }, 300);
        }
        
        // --- FILE HANDLING ---
        function handleFileClick(file) {
            if (file.name === 'users.db') { playBeep(1200, 'sine', 0.1); openBrowser('https://mvs-img.vercel.app/'); }
            else if (file.name === 'img.db') { playBeep(1200, 'sine', 0.1); openBrowser('https://mvs-img.vercel.app/'); }
            else if (file.name === 'call.db') { 
                playBeep(1200, 'sine', 0.1); 
                document.getElementById('win-game').classList.add('hidden-el');
                openBrowser('https://e8d07d6a0e1b5b4dc6f98d79f20e4c1e9f5.vercel.app/'); 
            }
            else if (file.name === 'SECRET_PAYLOAD.script') {
                playBeep(1200, 'sine', 0.1);
                openConfigModal();
            }
            else if (file.name === 'AI_CORE.exe') {
                playBeep(1200, 'sine', 0.1);
                openAIWindow();
            }
            else {
                playError(); const term = document.getElementById('term-output'); const div = document.createElement('div');
                div.className = 'text-red-500'; div.innerText = `> ERROR: File '${file.name}' is encrypted. Key missing.`;
                if(term) { term.appendChild(div); term.scrollTop = term.scrollHeight; }
            }
        }
        
        function renderFiles() {
            const container = document.getElementById('file-grid'); container.innerHTML = '';
            files.forEach((f, index) => {
                const div = document.createElement('div'); 
                div.className = 'group flex flex-col items-center p-2 hover:bg-white/5 cursor-pointer rounded transition-all file-item';
                div.style.animationDelay = `${index * 80}ms`; // Staggered delay
                div.onclick = () => handleFileClick(f);
                div.innerHTML = `<i class="fas ${f.icon} text-3xl ${f.color} mb-1 group-hover:scale-110 transition-transform"></i><span class="text-[9px] font-mono opacity-70 group-hover:opacity-100">${f.name}</span>`;
                container.appendChild(div);
            });
        }
        
        function launchDataVault() {
            playBeep(1000, 'square', 0.1);
            const win = document.getElementById('win-files');
            
            // Bring to front
            document.querySelectorAll('.window-panel').forEach(w => w.style.zIndex = 10);
            win.style.zIndex = 50;
        
            // Visual flash
            const originalBorder = win.style.borderColor;
            win.style.borderColor = "#fff";
            win.style.boxShadow = "0 0 30px var(--primary)";
            
            setTimeout(() => {
                win.style.borderColor = "var(--primary)";
                win.style.boxShadow = "";
            }, 300);
        
            // Re-render to simulate "Initiating"
            const grid = document.getElementById('file-grid');
            grid.innerHTML = '<div class="col-span-3 text-center text-xs animate-pulse">ACCESSING...</div>';
            setTimeout(renderFiles, 500);
            
            printToTerm("> PROTO_LAB: DATA_VAULT SYNC INITIATED.", "text-yellow-400");
        }

        // --- DECRYPTION PORTAL LOGIC ---
        let portalScanInterval;
        let portalProgress = 0;

        function submitPortal() {
            const input = document.getElementById('portal-input');
            const val = input.value.trim();
            const phase1 = document.getElementById('portal-phase-1');
            const phase2 = document.getElementById('portal-phase-2');
            const msg = document.getElementById('portal-msg');

            if (val === portalPin) {
                msg.style.opacity = '0';
                phase1.style.opacity = '0';
                phase1.style.pointerEvents = 'none';
                
                playSuccess();

                setTimeout(() => {
                    phase1.classList.add('hidden-el');
                    phase2.classList.remove('hidden-el');
                    void phase2.offsetWidth; 
                    phase2.style.opacity = '1';
                }, 300);
            } else {
                playError();
                msg.style.opacity = '1';
                input.value = "";
                input.focus();
                setTimeout(() => msg.style.opacity = '0', 2000);
            }
        }

        function startPortalBio() {
            const scanner = document.getElementById('portal-bio-scanner');
            const bar = document.getElementById('portal-bio-progress');
            const status = document.getElementById('portal-status');
            
            scanner.classList.add('scanning');
            playBeep(400, 'square', 2, 0.05);
            
            status.innerText = "VERIFYING BIOMETRICS...";
            status.style.color = "var(--primary)";

            portalScanInterval = setInterval(() => {
                portalProgress += 4;
                bar.style.width = portalProgress + '%';
                playBeep(400 + (portalProgress * 5), 'sawtooth', 0.05, 0.05);
                
                if (portalProgress >= 100) {
                    clearInterval(portalScanInterval);
                    completePortalSuccess();
                }
            }, 50);
        }

        function stopPortalBio() {
            clearInterval(portalScanInterval);
            const scanner = document.getElementById('portal-bio-scanner');
            const bar = document.getElementById('portal-bio-progress');
            const status = document.getElementById('portal-status');

            if (portalProgress < 100) {
                portalProgress = 0;
                bar.style.width = '0%';
                scanner.classList.remove('scanning');
                status.innerText = "ALIGNMENT FAILED. RETRY.";
                status.style.color = "red";
                playError();
            }
        }

        function completePortalSuccess() {
            const status = document.getElementById('portal-status');
            playSuccess();
            status.innerText = "IDENTITY CONFIRMED.";
            status.style.color = "#0f0";
            
            setTimeout(() => {
                if(!files.find(f => f.name === 'SECRET_PAYLOAD.script')) {
                    files.push({ icon: 'fa-file-code', color: 'text-red-500', name: 'SECRET_PAYLOAD.script' });
                    renderFiles();
                    printToTerm("> PORTAL BREACHED. PAYLOAD ACQUIRED.", "text-green-500");
                }
            }, 500);
        }

        // --- CONFIG MODAL LOGIC ---
        function openConfigModal() {
            document.getElementById('win-game').classList.add('hidden-el');
            const modal = document.getElementById('password-modal');
            const pinIn = document.getElementById('edit-pin-input');
            const portIn = document.getElementById('edit-portal-input');
            
            pinIn.value = systemPin;
            portIn.value = portalPin;
            
            modal.classList.remove('hidden-el');
            void modal.offsetWidth;
            modal.classList.add('modal-visible');
        }

        function saveConfig() {
            const pinIn = document.getElementById('edit-pin-input');
            const portIn = document.getElementById('edit-portal-input');
            
            const newPin = pinIn.value.trim();
            const newPort = portIn.value.trim();
            
            let changed = false;

            if(newPin.length > 0 && newPin.length <= 4 && !isNaN(newPin)) {
                systemPin = newPin;
                document.getElementById('pin-hint').innerText = "HINT: " + systemPin; 
                changed = true;
            }
            
            if(newPort.length > 0) {
                portalPin = newPort;
                changed = true;
            }

            if(changed) {
                playSuccess();
                printToTerm("> CONFIG UPDATE: CREDENTIALS MODIFIED.", "text-yellow-400");
                const btn = event.target;
                const oldText = btn.innerText;
                btn.innerText = "SAVED!";
                setTimeout(() => btn.innerText = oldText, 1000);
            } else {
                playError();
            }
        }

        function closeConfigModal() {
            const modal = document.getElementById('password-modal');
            modal.classList.remove('modal-visible');

            setTimeout(() => {
                modal.classList.add('hidden-el');
                const gameWin = document.getElementById('win-game');
                gameWin.classList.remove('hidden-el');
                playBeep(600, 'sawtooth', 0.2);
                files = files.filter(f => f.name !== 'SECRET_PAYLOAD.script');
                renderFiles();
                
                // RESET PORTAL STATE
                const phase1 = document.getElementById('portal-phase-1');
                const phase2 = document.getElementById('portal-phase-2');
                const input = document.getElementById('portal-input');
                const bioBar = document.getElementById('portal-bio-progress');
                const bioStatus = document.getElementById('portal-status');
                
                phase2.style.opacity = '0';
                phase2.classList.add('hidden-el');
                
                phase1.classList.remove('hidden-el');
                phase1.style.pointerEvents = 'auto';
                void phase1.offsetWidth; 
                phase1.style.opacity = '1';
                
                input.value = "";
                portalProgress = 0;
                bioBar.style.width = '0%';
                bioStatus.innerText = "";
                
                printToTerm("> SECURE SESSION CLOSED. TEMP FILES REMOVED.");
            }, 300);
        }

        // --- DRAG, TERM, CLOCK ---
        function makeDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0; const header = document.getElementById(elmnt.id + "-header");
            if (header) header.onmousedown = (e) => {
                e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY;
                document.querySelectorAll('.window-panel').forEach(w => w.style.zIndex = 10); elmnt.style.zIndex = 50;
                document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
                document.onmousemove = (e) => {
                    e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY;
                    elmnt.style.top = (elmnt.offsetTop - pos2) + "px"; elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                };
            };
        }
        makeDraggable(document.getElementById("win-sys")); makeDraggable(document.getElementById("win-files"));
        makeDraggable(document.getElementById("win-term")); makeDraggable(document.getElementById("win-game"));
        makeDraggable(document.getElementById("win-ai"));
        makeDraggable(document.getElementById("win-design"));

        const termInput = document.getElementById('term-input'), termOutput = document.getElementById('term-output');
        termInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const val = this.value.trim().toLowerCase(); playBeep(500); printToTerm(`root@sys:~# ${this.value}`, 'text-green-500');
                if (val.startsWith('theme')) {
                    const arg = val.split(' ')[1];
                    if(['red','green','gold'].includes(arg)) { document.body.className = `theme-${arg}`; printToTerm(`> Theme set to ${arg}.`, 'text-blue-400'); }
                    else { document.body.className = ''; printToTerm('> Theme reset to default.', 'text-blue-400'); }
                } else if (val === 'clear') termOutput.innerHTML = '';
                else if (val === 'reboot') location.reload();
                else if (val !== '') printToTerm(`Error: ${val} not found`, 'text-red-500');
                this.value = ''; termOutput.scrollTop = termOutput.scrollHeight;
            }
        });
        function printToTerm(text, className = '') { const div = document.createElement('div'); div.className = className; div.innerText = text; termOutput.appendChild(div); }
        
        function startClock() {
             setInterval(() => { 
                const clock = document.getElementById('clock');
                if(clock) clock.innerText = new Date().toISOString().split('T')[1].split('.')[0]; 
            }, 1000);
        }
        
        function logout() { location.reload(); }

        // --- AI CHAT LOGIC ---
        function openAIWindow() {
            const aiWin = document.getElementById('win-ai');
            aiWin.classList.remove('hidden-el');
            aiWin.style.zIndex = 60;
            setTimeout(() => document.getElementById('ai-input').focus(), 100);
        }

        function closeAI() {
            document.getElementById('win-ai').classList.add('hidden-el');
        }

        async function sendAIQuery() {
            const input = document.getElementById('ai-input');
            const display = document.getElementById('ai-chat-display');
            const text = input.value.trim();
            
            if (!text) return;
            
            addMessageToChat('USER', text);
            input.value = '';
            
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'msg-bubble msg-ai';
            loadingDiv.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
            display.appendChild(loadingDiv);
            display.scrollTop = display.scrollHeight;

            try {
                const responseText = await generateGeminiContent(text);
                document.getElementById(loadingId).remove();
                addMessageToChat('AI', responseText);
            } catch (error) {
                document.getElementById(loadingId).remove();
                addMessageToChat('SYS', 'CONNECTION ERROR: NEURAL LINK FAILED');
            }
        }

        function addMessageToChat(sender, text) {
            const display = document.getElementById('ai-chat-display');
            const div = document.createElement('div');
            
            let typeClass = 'msg-ai';
            if (sender === 'USER') typeClass = 'msg-user';
            
            div.className = `msg-bubble ${typeClass} status-animate relative group`;
            div.innerText = text; 
            
            if (sender === 'AI') {
                div.style.cursor = 'pointer';
                div.title = "Click to Copy";
                div.classList.add('hover:brightness-125');
                div.onclick = function() {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        printToTerm("> COPIED TO CLIPBOARD", "text-green-500");
                        playBeep(1200, 'sine', 0.1);
                        const originalBg = div.style.backgroundColor;
                        div.style.backgroundColor = 'rgba(0, 243, 255, 0.3)';
                        setTimeout(() => div.style.backgroundColor = originalBg, 200);
                    } catch (err) {
                        console.error('Copy failed', err);
                    }
                    document.body.removeChild(textarea);
                };
            }
            
            display.appendChild(div);
            display.scrollTop = display.scrollHeight;
            playBeep(800, 'sine', 0.05, 0.05);
        }

        async function generateGeminiContent(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const delays = [1000, 2000, 4000, 8000, 16000];
            
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.[0]?.parts?.[0]?.text || "NO DATA RECEIVED.";
                } catch (e) {
                    if (i === 4) throw e;
                    await new Promise(resolve => setTimeout(resolve, delays[i]));
                }
            }
        }
    </script>
</body>
</html>
