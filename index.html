<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURAL OS v9.9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=VT323&family=Share+Tech+Mono&display=swap');

        :root {
            --primary: #00f3ff;
            --secondary: #bc13fe;
            --bg: #050505;
            --glass: rgba(6, 182, 212, 0.1);
            --scanline-color: rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: var(--bg);
            color: var(--primary);
            overflow: hidden;
            cursor: crosshair;
            user-select: none;
            transition: color 0.5s, background-color 0.5s;
        }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 1024px) {
            body { overflow: hidden; }
            .window-panel {
                position: relative !important;
                top: auto !important; left: auto !important;
                width: 90% !important; max-width: 500px;
                margin: 0 auto 20px auto; min-width: 0 !important;
            }
            #dashboard-stage {
                overflow-y: auto !important; display: flex; flex-direction: column;
                padding-top: 70px; padding-bottom: 40px;
            }
            .window-content { max-height: 250px; }
            .taskbar-hide-mobile { display: none; }
            
            /* Browser Mobile Fix */
            #browser-stage {
                width: 95% !important;
                height: 80% !important;
                top: 60px !important;
                left: 2.5% !important;
            }
        }

        /* --- THEME CLASSES --- */
        body.theme-red { --primary: #ff2a2a; --secondary: #ffae00; }
        body.theme-green { --primary: #00ff2a; --secondary: #008800; }
        body.theme-gold { --primary: #ffd700; --secondary: #ff8800; }

        /* --- CRT OVERLAY --- */
        .crt-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 3px, 3px 100%;
            pointer-events: none; z-index: 9999;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
            animation: flicker 0.15s infinite;
        }
        @keyframes flicker { 0% { opacity: 0.92; } 100% { opacity: 1; } }

        /* --- BOOT SCREEN --- */
        #boot-screen {
            position: fixed; inset: 0; background: #000; z-index: 100;
            padding: 2rem; display: flex; flex-direction: column; justify-content: flex-end;
            font-family: 'VT323', monospace; font-size: 1.2rem; color: #ccc; text-shadow: 0 0 5px #ccc;
        }
        .boot-line { margin: 2px 0; }

        /* --- WINDOWS --- */
        .window-panel {
            position: absolute;
            background: rgba(10, 15, 30, 0.9); backdrop-filter: blur(8px);
            border: 1px solid var(--primary); box-shadow: 0 0 20px rgba(0, 243, 255, 0.15);
            color: #fff; display: flex; flex-direction: column;
            transition: box-shadow 0.2s; min-width: 300px;
        }
        .window-panel:active { box-shadow: 0 0 40px var(--primary); z-index: 50; }
        .window-header {
            background: rgba(255, 255, 255, 0.05); padding: 6px 12px; cursor: grab;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--primary); font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem; letter-spacing: 1px; color: var(--primary);
        }
        .window-header:active { cursor: grabbing; }
        .window-content { padding: 16px; overflow-y: auto; max-height: 400px; position: relative; }

        /* --- TERMINAL --- */
        .terminal-text { font-family: 'VT323', monospace; font-size: 1.1rem; color: var(--primary); line-height: 1.2; }

        /* --- BIOMETRIC --- */
        .fingerprint-container {
            position: relative; width: 80px; height: 80px; margin: 0 auto 20px;
            cursor: pointer; transition: transform 0.2s;
        }
        .fingerprint-container:active { transform: scale(0.95); }
        .fingerprint-icon { font-size: 80px; color: rgba(255,255,255,0.1); transition: color 0.5s; }
        .fingerprint-container:hover .fingerprint-icon { color: rgba(255,255,255,0.3); }
        .scan-beam {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: var(--primary); box-shadow: 0 0 15px var(--primary);
            opacity: 0; pointer-events: none;
        }
        .scanning .scan-beam { opacity: 1; animation: scanMove 1.5s ease-in-out infinite; }
        .scanning .fingerprint-icon { color: var(--primary); text-shadow: 0 0 15px var(--primary); }
        @keyframes scanMove { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }

        /* --- KEYPAD --- */
        .cyber-btn {
            background: rgba(0, 0, 0, 0.3); border: 1px solid var(--primary); color: var(--primary);
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        .cyber-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); }
        .cyber-btn:active { transform: scale(0.95); }

        /* --- UTILS --- */
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.15; }
        .hidden-el { display: none !important; }
        .fade-in { animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
        ::-webkit-scrollbar-track { background: #000; }

        /* --- SCANNER BUTTON --- */
        .scanner-btn {
            position: relative;
            overflow: hidden;
        }
        .scanner-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-25deg);
        }
        .scanner-btn.scanning::after {
            animation: scanBtn 1s linear infinite;
        }
        @keyframes scanBtn {
            0% { left: -100%; }
            100% { left: 200%; }
        }

        /* --- SMOOTH ANIMATIONS --- */
        #password-modal {
            transition: opacity 0.3s ease, backdrop-filter 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        #password-modal.modal-visible {
            opacity: 1;
            pointer-events: auto;
        }
        #password-modal .window-panel {
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            transform: scale(0.9) translateY(20px);
        }
        #password-modal.modal-visible .window-panel {
            transform: scale(1) translateY(0);
        }
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.8); filter: blur(4px); }
            100% { opacity: 1; transform: scale(1); filter: blur(0); }
        }
        .file-item {
            opacity: 0;
            animation: popIn 0.4s cubic-bezier(0.19, 1, 0.22, 1) forwards;
        }
        @keyframes slideUpFade {
            0% { opacity: 0; transform: translateY(5px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .status-animate {
            animation: slideUpFade 0.3s ease-out forwards;
        }

        /* --- BROWSER OVERLAY FIX --- */
        /* Z-index 10000 ensures it sits ABOVE the CRT overlay (z-index 9999) */
        #browser-stage {
            z-index: 10000 !important;
        }

    </style>
</head>
<body>

    <div id="boot-screen"></div>
    <div class="crt-overlay"></div>
    <canvas id="matrix-canvas"></canvas>

    <!-- LOGIN STAGE -->
    <div id="login-stage" class="hidden-el h-screen w-full flex items-center justify-center relative z-10 transition-all duration-700 px-4">
        <div id="login-panel" class="w-full max-w-[420px] bg-black/80 border border-current p-8 backdrop-blur-xl relative overflow-hidden" style="border-color: var(--primary);">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-current to-transparent" style="color: var(--primary)"></div>
            <div class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-current to-transparent" style="color: var(--primary)"></div>
            
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black tracking-[0.2em] text-white" style="text-shadow: 0 0 10px var(--primary)">NEURAL_GATE</h1>
                <p class="text-[10px] opacity-70 mt-2 tracking-[0.3em]">SECURE ACCESS POINT // V9.9</p>
            </div>

            <!-- BIOMETRIC -->
            <div id="bio-phase" class="flex flex-col items-center justify-center py-6">
                <div id="bio-scanner" class="fingerprint-container" onmousedown="startScan()" onmouseup="stopScan()" onmouseleave="stopScan()" ontouchstart="startScan()" ontouchend="stopScan()">
                    <i class="fas fa-fingerprint fingerprint-icon"></i>
                    <div class="scan-beam"></div>
                </div>
                <p id="bio-text" class="text-xs font-mono animate-pulse" style="color: var(--primary)">HOLD TO SCAN BIOMETRICS</p>
                <div class="w-full h-1 bg-gray-900 mt-4 rounded-full overflow-hidden">
                    <div id="bio-progress" class="h-full w-0 transition-all duration-100 ease-linear" style="background-color: var(--primary)"></div>
                </div>
            </div>

            <!-- PIN -->
            <div id="pin-phase" class="hidden-el fade-in">
                <div class="mb-6 relative">
                    <div class="flex justify-between text-[10px] text-gray-500 mb-1 font-mono">
                        <span>REQ: DIGIT PIN</span><span id="pin-hint">[ Hint: Unknown ]</span>
                    </div>
                    <div id="pin-display" class="h-14 bg-black border border-current flex items-center justify-center text-3xl tracking-[1em] font-sans relative shadow-inner" style="color: var(--primary); border-color: var(--primary);"></div>
                    <p id="pin-msg" class="text-center text-xs text-red-500 font-bold mt-2 h-4 opacity-0">INVALID CODE</p>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <button onclick="pressKey(1)" class="cyber-btn h-12 text-xl font-bold">1</button>
                    <button onclick="pressKey(2)" class="cyber-btn h-12 text-xl font-bold">2</button>
                    <button onclick="pressKey(3)" class="cyber-btn h-12 text-xl font-bold">3</button>
                    <button onclick="pressKey(4)" class="cyber-btn h-12 text-xl font-bold">4</button>
                    <button onclick="pressKey(5)" class="cyber-btn h-12 text-xl font-bold">5</button>
                    <button onclick="pressKey(6)" class="cyber-btn h-12 text-xl font-bold">6</button>
                    <button onclick="pressKey(7)" class="cyber-btn h-12 text-xl font-bold">7</button>
                    <button onclick="pressKey(8)" class="cyber-btn h-12 text-xl font-bold">8</button>
                    <button onclick="pressKey(9)" class="cyber-btn h-12 text-xl font-bold">9</button>
                    <button onclick="clearPin()" class="cyber-btn h-12 text-sm font-bold border-red-500 text-red-500">CLR</button>
                    <button onclick="pressKey(0)" class="cyber-btn h-12 text-xl font-bold">0</button>
                    <button onclick="submitPin()" class="cyber-btn h-12 text-sm font-bold bg-white/10">ENT</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-stage" class="hidden-el fixed inset-0 z-20 overflow-hidden lg:overflow-hidden opacity-0 transition-opacity duration-1000">
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_#111827_0%,_#000000_100%)] z-[-1]"></div>
        
        <!-- Taskbar -->
        <div class="absolute top-0 w-full h-12 bg-black/80 border-b flex items-center justify-between px-4 backdrop-blur z-50" style="border-color: rgba(255,255,255,0.1)">
            <div class="flex items-center gap-4">
                <i class="fas fa-shield-halved text-xl animate-pulse" style="color: var(--primary)"></i>
                <span class="font-mono text-sm tracking-widest text-gray-300">SYSTEM <span class="text-green-500">ONLINE</span></span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleAmbience()" id="ambience-btn" class="cyber-btn px-2 py-1 text-[10px] uppercase border rounded taskbar-hide-mobile">
                    <i class="fas fa-volume-off mr-1"></i> Audio
                </button>
                <div class="text-xs font-mono" style="color: var(--primary)" id="clock">00:00:00</div>
                <button onclick="logout()" class="text-red-500 hover:text-white border border-red-900 px-3 py-1 hover:bg-red-600 transition-colors uppercase text-[10px] tracking-wider">Logoff</button>
            </div>
        </div>

        <!-- Win 1: SYS -->
        <div id="win-sys" class="window-panel" style="top: 80px; left: 30px;">
            <div id="win-sys-header" class="window-header">
                <span><i class="fas fa-server mr-2"></i>SYS_MONITOR</span>
                <div class="flex gap-1"><div class="w-2 h-2 rounded-full bg-yellow-500"></div><div class="w-2 h-2 rounded-full bg-green-500"></div></div>
            </div>
            <div class="window-content font-mono text-xs text-gray-300">
                <div class="mb-4 flex items-center justify-between">
                    <span>CPU_LOAD</span>
                    <div class="w-32 h-2 bg-gray-800 rounded-full overflow-hidden">
                        <div class="h-full bg-current animate-[pulse_2s_infinite]" style="width: 45%; color: var(--primary)"></div>
                    </div>
                </div>
                <div class="mb-4 flex items-center justify-between">
                    <span>MEM_ALLOC</span>
                    <div class="w-32 h-2 bg-gray-800 rounded-full overflow-hidden">
                        <div class="h-full bg-purple-500 animate-[pulse_3s_infinite]" style="width: 72%"></div>
                    </div>
                </div>
                <div class="border-t border-gray-700 pt-2 mt-2">
                    <p class="mb-1" style="color: var(--primary)">> Connecting to satellite...</p>
                    <p class="text-green-500 mb-1">> Connection established.</p>
                    <p class="text-gray-500">> Uplink secure.</p>
                </div>
            </div>
        </div>

        <!-- Win 2: FILES -->
        <div id="win-files" class="window-panel" style="top: 130px; left: 400px;">
            <div id="win-files-header" class="window-header">
                <span><i class="fas fa-folder-open mr-2"></i>DATA_VAULT</span>
                <div class="flex gap-1"><div class="w-2 h-2 rounded-full bg-yellow-500"></div><div class="w-2 h-2 rounded-full bg-green-500"></div></div>
            </div>
            <div class="window-content">
                <div id="file-grid" class="grid grid-cols-3 gap-2"></div>
            </div>
        </div>

        <!-- Win 3: TERM -->
        <div id="win-term" class="window-panel w-full max-w-[500px]" style="top: 380px; left: 80px;">
            <div id="win-term-header" class="window-header bg-black/50">
                <span><i class="fas fa-terminal mr-2"></i>ROOT_TERMINAL</span>
                <div class="flex gap-1"><div class="w-2 h-2 rounded-full bg-yellow-500"></div><div class="w-2 h-2 rounded-full bg-green-500"></div></div>
            </div>
            <div class="window-content bg-black/90 font-mono h-48 flex flex-col" onclick="document.getElementById('term-input').focus()">
                <div id="term-output" class="flex-1 terminal-text overflow-y-auto mb-2 scrollbar-thin">
                    <div class="opacity-50">NEURAL_OS [Version 9.9.0]</div>
                    <div class="opacity-50">(c) CyberCorp. All rights reserved.</div><br>
                    <div style="color: var(--primary)">Type 'help' for available commands.</div>
                </div>
                <div class="flex items-center text-lg">
                    <span class="mr-2 text-green-500">root@sys:~#</span>
                    <input type="text" id="term-input" class="bg-transparent border-none outline-none w-full font-mono uppercase" style="color: var(--primary)" autocomplete="off">
                </div>
            </div>
        </div>

        <!-- Win 4: PORTAL DECRYPTER (Formerly Game) -->
        <div id="win-game" class="window-panel w-[300px]" style="top: 100px; left: 750px;">
             <div id="win-game-header" class="window-header">
                <span><i class="fas fa-lock-open mr-2"></i>DECRYPTION_PORTAL</span>
                <div class="flex gap-1"><div class="w-2 h-2 rounded-full bg-yellow-500"></div><div class="w-2 h-2 rounded-full bg-green-500"></div></div>
            </div>
            <div class="window-content flex flex-col items-center p-6 gap-4 relative h-[280px]">
                
                <!-- Phase 1: Password -->
                <div id="portal-phase-1" class="w-full flex flex-col items-center gap-4 transition-all duration-500">
                    <div class="text-center">
                        <i class="fas fa-shield-cat text-4xl mb-2" style="color: var(--primary)"></i>
                        <p class="text-[10px] font-mono opacity-70">ENTER PORTAL ACCESS CODE</p>
                        <p class="text-[9px] text-gray-500">[ DEFAULT: 999 ]</p>
                    </div>
                    
                    <input type="password" id="portal-input" class="bg-black border border-[var(--primary)] text-center text-xl font-mono py-2 w-full focus:outline-none shadow-[inset_0_0_10px_rgba(0,0,0,0.8)] placeholder-gray-800" placeholder="***" maxlength="10" autocomplete="off" style="color: var(--primary)">
                    
                    <button onclick="submitPortal()" id="portal-btn" class="scanner-btn cyber-btn w-full py-3 flex items-center justify-center gap-2 font-bold text-sm group">
                        <i class="fas fa-fingerprint group-hover:scale-110 transition-transform"></i>
                        <span>SCAN IDENTITY</span>
                    </button>

                    <div id="portal-msg" class="text-xs font-bold h-4 text-center text-red-500 opacity-0 transition-opacity">INVALID CREDENTIALS</div>
                </div>

                <!-- Phase 2: Biometric -->
                <div id="portal-phase-2" class="absolute inset-0 flex flex-col items-center justify-center bg-black/95 z-10 hidden-el opacity-0 transition-opacity duration-500">
                      <p class="text-[10px] font-mono mb-6 text-center animate-pulse" style="color: var(--primary)">BIOMETRIC CONFIRMATION REQUIRED</p>
                      <div id="portal-bio-scanner" class="fingerprint-container scale-90" 
                           onmousedown="startPortalBio()" onmouseup="stopPortalBio()" onmouseleave="stopPortalBio()" 
                           ontouchstart="startPortalBio()" ontouchend="stopPortalBio()">
                        <i class="fas fa-fingerprint fingerprint-icon"></i>
                        <div class="scan-beam"></div>
                    </div>
                    <div class="w-40 h-1 bg-gray-800 mt-6 rounded-full overflow-hidden">
                        <div id="portal-bio-progress" class="h-full w-0 transition-all duration-100 ease-linear" style="background-color: var(--primary)"></div>
                    </div>
                    <p id="portal-status" class="text-xs font-bold mt-4 h-4 tracking-wider text-center"></p>
                </div>

            </div>
        </div>
    </div>

    <!-- BROWSER STAGE (Converted to Window) -->
    <div id="browser-stage" class="hidden-el window-panel z-50 flex flex-col transition-opacity duration-300" style="width: 80%; height: 80%; top: 10%; left: 10%;">
        <div id="browser-stage-header" class="window-header h-14 border-b border-[#00f3ff] bg-black/90 flex items-center px-4 gap-4 shadow-[0_0_20px_rgba(0,243,255,0.1)]">
            <button onclick="closeBrowser()" class="cyber-btn h-8 w-8 flex items-center justify-center rounded hover:bg-[#00f3ff]/20 text-[#00f3ff] border border-[#00f3ff]">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="flex-1 bg-black border border-[#00f3ff]/30 rounded px-4 py-2 text-xs font-mono text-[#00f3ff] tracking-widest flex items-center gap-2 shadow-inner">
                <i class="fas fa-lock text-[10px]"></i>
                <span id="browser-url">SECURE_LINK::EXTERNAL_SOURCE</span>
            </div>
            <div class="flex gap-2"><div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div></div>
        </div>
        <iframe id="browser-frame" class="flex-1 w-full h-full border-none bg-white" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
    </div>

    <!-- CONFIG MODAL (New Password & Exit) -->
    <!-- Removed hidden-el by default in HTML, managed by JS to allow transitions, but initial state is opacity 0 via CSS -->
    <div id="password-modal" class="fixed inset-0 z-[60] bg-black/90 backdrop-blur-md flex items-center justify-center hidden-el">
        <div class="window-panel w-[350px] border border-[var(--primary)] shadow-[0_0_50px_rgba(0,243,255,0.2)] bg-black">
            <div class="window-header">
                <span><i class="fas fa-cogs mr-2"></i>ROOT_ACCESS_CONFIG</span>
                <i class="fas fa-unlock text-green-500"></i>
            </div>
            <div class="window-content flex flex-col gap-6 p-6">
                <div class="text-center border-b border-gray-800 pb-4">
                    <h2 class="text-xl font-bold tracking-widest text-white">SYSTEM OVERRIDE</h2>
                    <p class="text-[10px] text-gray-500 mt-1">MODIFY SECURITY CREDENTIALS</p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-mono text-[var(--primary)] block mb-1">MAIN SYSTEM PIN</label>
                        <input type="text" id="edit-pin-input" class="w-full bg-gray-900 border border-gray-700 text-white text-center text-lg font-mono py-2 focus:outline-none focus:border-[var(--primary)] transition-colors" maxlength="4">
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-mono text-[var(--primary)] block mb-1">PORTAL ACCESS CODE</label>
                        <input type="text" id="edit-portal-input" class="w-full bg-gray-900 border border-gray-700 text-white text-center text-lg font-mono py-2 focus:outline-none focus:border-[var(--primary)] transition-colors" maxlength="10">
                    </div>
                </div>

                <div class="flex gap-3 mt-2">
                    <button onclick="saveConfig()" class="flex-1 cyber-btn py-3 text-xs font-bold hover:bg-[var(--primary)] hover:text-black transition-all">SAVE CHANGES</button>
                    <button onclick="closeConfigModal()" class="flex-1 border border-red-500 text-red-500 hover:bg-red-900/30 py-3 text-xs font-bold transition-all">EXIT & LOCK</button>
                </div>
                
                <p class="text-[9px] text-center text-gray-600 mt-2">*Exiting will purge the config payload from memory.</p>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBALS ---
        let systemPin = "340";
        let portalPin = "999";
        
        let files = [
            { icon: 'fa-file-pdf', color: 'text-red-400', name: 'PLANS_V2.pdf' },
            { icon: 'fa-file-image', color: 'text-purple-400', name: 'EVIDENCE.jpg' },
            { icon: 'fa-file-code', color: 'text-yellow-400', name: 'VIRUS.exe' },
            { icon: 'fa-database', color: 'text-green-400', name: 'users.db' },
            { icon: 'fa-database', color: 'text-orange-400', name: 'img.db' },
            { icon: 'fa-address-book', color: 'text-blue-400', name: 'call.db' }
        ];

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let ambienceOsc = null;
        let ambienceGain = null;

        function playBeep(freq = 800, type = 'sine', duration = 0.05, vol = 0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        function toggleAmbience() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const btn = document.getElementById('ambience-btn');
            if (ambienceOsc) {
                ambienceGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1);
                ambienceOsc.stop(audioCtx.currentTime + 1); ambienceOsc = null;
                btn.innerHTML = '<i class="fas fa-volume-off mr-1"></i> Audio'; btn.classList.remove('bg-white/20');
            } else {
                ambienceOsc = audioCtx.createOscillator(); ambienceGain = audioCtx.createGain();
                ambienceOsc.type = 'sawtooth'; ambienceOsc.frequency.setValueAtTime(50, audioCtx.currentTime);
                const filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 200;
                ambienceGain.gain.setValueAtTime(0, audioCtx.currentTime);
                ambienceGain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 2);
                ambienceOsc.connect(filter); filter.connect(ambienceGain); ambienceGain.connect(audioCtx.destination);
                ambienceOsc.start();
                btn.innerHTML = '<i class="fas fa-volume-up mr-1"></i> Audio'; btn.classList.add('bg-white/20');
            }
        }

        function playError() { playBeep(150, 'sawtooth', 0.3); setTimeout(() => playBeep(100, 'sawtooth', 0.3), 150); }
        function playSuccess() { playBeep(1200, 'sine', 0.1); setTimeout(() => playBeep(1800, 'square', 0.2), 100); }

        // --- BOOT ---
        const bootLines = ["NEURAL BIOS v9.9 - (c) 2099 CyberCorp", "Checking Memory... OK", "Loading Kernel... OK", "Mounting /dev/brain0... OK", "Connecting to Neural Net...", "Established.", "Booting System..."];
        async function runBoot() {
            const screen = document.getElementById('boot-screen');
            for(let line of bootLines) {
                const div = document.createElement('div'); div.className = 'boot-line'; div.innerHTML = `> ${line}`;
                screen.appendChild(div); playBeep(800, 'square', 0.01, 0.02);
                await new Promise(r => setTimeout(r, Math.random() * 200 + 50));
            }
            await new Promise(r => setTimeout(r, 600));
            screen.style.opacity = '0';
            setTimeout(() => { screen.classList.add('hidden-el'); document.getElementById('login-stage').classList.remove('hidden-el'); }, 500);
        }
        window.onload = runBoot;

        // --- MATRIX ---
        const canvas = document.getElementById('matrix-canvas'), ctx = canvas.getContext('2d');
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas); resizeCanvas();
        const alphabet = '01XY'.split('');
        const fontSize = 14;
        let columns = canvas.width/fontSize, rainDrops = Array(Math.floor(columns)).fill(1);
        window.addEventListener('resize', () => { columns = canvas.width/fontSize; rainDrops = Array(Math.floor(columns)).fill(1); });
        function drawMatrix() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--primary').trim() || '#00f3ff';
            ctx.font = fontSize + 'px monospace';
            for(let i = 0; i < rainDrops.length; i++) {
                const text = alphabet[Math.floor(Math.random() * alphabet.length)];
                ctx.fillText(text, i*fontSize, rainDrops[i]*fontSize);
                if(rainDrops[i]*fontSize > canvas.height && Math.random() > 0.975) rainDrops[i] = 0;
                rainDrops[i]++;
            }
        }
        setInterval(drawMatrix, 50);

        // --- BIOMETRIC ---
        let scanInterval, progress = 0;
        const bioScanner = document.getElementById('bio-scanner'), bioProgress = document.getElementById('bio-progress'), bioText = document.getElementById('bio-text');
        const bioPhase = document.getElementById('bio-phase'), pinPhase = document.getElementById('pin-phase');
        function startScan() {
            bioScanner.classList.add('scanning'); playBeep(200, 'sine', 2);
            bioText.innerText = "SCANNING..."; bioText.classList.remove('animate-pulse');
            scanInterval = setInterval(() => {
                progress += 2; bioProgress.style.width = progress + '%'; playBeep(200 + progress * 10, 'sine', 0.05);
                if (progress >= 100) { clearInterval(scanInterval); completeScan(); }
            }, 30);
        }
        function stopScan() {
            clearInterval(scanInterval);
            if (progress < 100) {
                progress = 0; bioProgress.style.width = '0%'; bioScanner.classList.remove('scanning');
                bioText.innerText = "HOLD TO SCAN BIOMETRICS"; bioText.classList.add('animate-pulse');
            }
        }
        function completeScan() {
            playSuccess(); bioText.innerText = "IDENTITY VERIFIED";
            setTimeout(() => { bioPhase.classList.add('hidden-el'); pinPhase.classList.remove('hidden-el'); }, 800);
        }

        // --- PIN ---
        let currentPin = "";
        const pinDisplay = document.getElementById('pin-display'), pinMsg = document.getElementById('pin-msg');
        function updatePinDisplay() { pinDisplay.innerText = '‚óè'.repeat(currentPin.length); }
        function pressKey(num) { if (currentPin.length < 4) { currentPin += num; updatePinDisplay(); pinMsg.style.opacity = '0'; playBeep(600 + (num * 50)); } }
        function clearPin() { currentPin = ""; updatePinDisplay(); pinMsg.style.opacity = '0'; playBeep(300); }
        function submitPin() {
            if (currentPin === systemPin || currentPin === "1234") {
                playSuccess(); pinDisplay.style.color = '#0f0'; setTimeout(unlockSystem, 500);
            } else {
                playError(); pinMsg.style.opacity = '1'; currentPin = ""; updatePinDisplay();
                document.getElementById('login-panel').animate([{ transform: 'translateX(-5px)' }, { transform: 'translateX(5px)' }, { transform: 'translateX(0)' }], { duration: 200 });
            }
        }
        function unlockSystem() {
            document.getElementById('login-stage').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-stage').classList.add('hidden-el');
                const dash = document.getElementById('dashboard-stage');
                dash.classList.remove('hidden-el');
                requestAnimationFrame(() => dash.style.opacity = '1');
                startClock(); renderFiles();
            }, 500);
        }

        // --- BROWSER ---
        function openBrowser(url) {
            const browser = document.getElementById('browser-stage'), frame = document.getElementById('browser-frame');
            frame.src = url; browser.classList.remove('hidden-el');
            browser.style.opacity = '0'; browser.style.transform = 'scale(0.95)';
            requestAnimationFrame(() => { browser.style.transition = 'all 0.3s ease-out'; browser.style.opacity = '1'; browser.style.transform = 'scale(1)'; });
        }
        function openInternalBrowser(htmlContent) {
            const browser = document.getElementById('browser-stage'), frame = document.getElementById('browser-frame'), urlDisplay = document.getElementById('browser-url');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'contact-pro-74f93';
            const injection = `<script>const __app_id = "${appId}";<\/script>`;
            
            // Inject Cyber Theme CSS to override white background
            const darkTheme = `<style>
                body { background: transparent !important; color: #00f3ff !important; font-family: "Share Tech Mono", monospace !important; }
                .glass-header { background: rgba(0, 20, 30, 0.9) !important; border-bottom: 1px solid #00f3ff !important; backdrop-filter: none !important; }
                .contact-card { background: rgba(0, 10, 20, 0.8) !important; border: 1px solid #00f3ff !important; box-shadow: 0 0 10px rgba(0,243,255,0.1) !important; color: #00f3ff !important; }
                .text-brand-950, .text-brand-900, .text-gray-900, .text-gray-500, h3, h2, p, span { color: #00f3ff !important; }
                .text-brand-600 { color: #bc13fe !important; }
                .bg-brand-50, .bg-brand-600, .bg-white { background: rgba(0, 10, 20, 0.95) !important; border-color: #00f3ff !important; }
                input { background: rgba(0,0,0,0.5) !important; border: 1px solid #00f3ff !important; color: #fff !important; }
                button { border: 1px solid #00f3ff !important; }
                .shadow-lg { box-shadow: none !important; }
            </style>`;
            
            frame.srcdoc = injection + darkTheme + htmlContent;
            urlDisplay.innerText = "LOCAL_DB::CONTACT_SAVER_PRO";
            browser.classList.remove('hidden-el');
            browser.style.opacity = '0'; browser.style.transform = 'scale(0.95)';
            requestAnimationFrame(() => { browser.style.transition = 'all 0.3s ease-out'; browser.style.opacity = '1'; browser.style.transform = 'scale(1)'; });
        }
        function closeBrowser() {
            const browser = document.getElementById('browser-stage'), frame = document.getElementById('browser-frame');
            browser.style.opacity = '0'; browser.style.transform = 'scale(0.95)';
            setTimeout(() => { 
                browser.classList.add('hidden-el'); 
                frame.src = ''; 
                frame.removeAttribute('srcdoc'); 
                // Restore Decryption window when browser closes
                document.getElementById('win-game').classList.remove('hidden-el');
            }, 300);
        }
        
        // --- FILE HANDLING ---
        function handleFileClick(file) {
            if (file.name === 'users.db') { playBeep(1200, 'sine', 0.1); openBrowser('https://mvs-img.vercel.app/'); }
            else if (file.name === 'img.db') { playBeep(1200, 'sine', 0.1); openBrowser('https://b91ce9b2e9c5b7c6c6b5c94c7b1f7c0a0a9.vercel.app/'); }
            else if (file.name === 'call.db') { 
                playBeep(1200, 'sine', 0.1); 
                document.getElementById('win-game').classList.add('hidden-el');
                openInternalBrowser(contactSaverSource); 
            }
            else if (file.name === 'SECRET_PAYLOAD.script') {
                playBeep(1200, 'sine', 0.1);
                openConfigModal();
            }
            else {
                playError(); const term = document.getElementById('term-output'); const div = document.createElement('div');
                div.className = 'text-red-500'; div.innerText = `> ERROR: File '${file.name}' is encrypted. Key missing.`;
                if(term) { term.appendChild(div); term.scrollTop = term.scrollHeight; }
            }
        }
        
        function renderFiles() {
            const container = document.getElementById('file-grid'); container.innerHTML = '';
            files.forEach((f, index) => {
                const div = document.createElement('div'); 
                div.className = 'group flex flex-col items-center p-2 hover:bg-white/5 cursor-pointer rounded transition-all file-item';
                div.style.animationDelay = `${index * 80}ms`; // Staggered delay
                div.onclick = () => handleFileClick(f);
                div.innerHTML = `<i class="fas ${f.icon} text-3xl ${f.color} mb-1 group-hover:scale-110 transition-transform"></i><span class="text-[9px] font-mono opacity-70 group-hover:opacity-100">${f.name}</span>`;
                container.appendChild(div);
            });
        }

        // --- DECRYPTION PORTAL LOGIC (Revised) ---
        let portalScanInterval;
        let portalProgress = 0;

        function submitPortal() {
            const input = document.getElementById('portal-input');
            const val = input.value.trim();
            const phase1 = document.getElementById('portal-phase-1');
            const phase2 = document.getElementById('portal-phase-2');
            const msg = document.getElementById('portal-msg');

            if (val === portalPin) {
                // Valid: Transition to Phase 2 (Biometric)
                msg.style.opacity = '0';
                phase1.style.opacity = '0';
                phase1.style.pointerEvents = 'none';
                
                playSuccess();

                setTimeout(() => {
                    phase1.classList.add('hidden-el');
                    phase2.classList.remove('hidden-el');
                    // Force reflow
                    void phase2.offsetWidth; 
                    phase2.style.opacity = '1';
                }, 300);
            } else {
                // Invalid
                playError();
                msg.style.opacity = '1';
                input.value = "";
                input.focus();
                setTimeout(() => msg.style.opacity = '0', 2000);
            }
        }

        function startPortalBio() {
            const scanner = document.getElementById('portal-bio-scanner');
            const bar = document.getElementById('portal-bio-progress');
            const status = document.getElementById('portal-status');
            
            scanner.classList.add('scanning');
            playBeep(400, 'square', 2, 0.05);
            
            status.innerText = "VERIFYING BIOMETRICS...";
            status.style.color = "var(--primary)";

            portalScanInterval = setInterval(() => {
                portalProgress += 4;
                bar.style.width = portalProgress + '%';
                playBeep(400 + (portalProgress * 5), 'sawtooth', 0.05, 0.05);
                
                if (portalProgress >= 100) {
                    clearInterval(portalScanInterval);
                    completePortalSuccess();
                }
            }, 50);
        }

        function stopPortalBio() {
            clearInterval(portalScanInterval);
            const scanner = document.getElementById('portal-bio-scanner');
            const bar = document.getElementById('portal-bio-progress');
            const status = document.getElementById('portal-status');

            if (portalProgress < 100) {
                portalProgress = 0;
                bar.style.width = '0%';
                scanner.classList.remove('scanning');
                status.innerText = "ALIGNMENT FAILED. RETRY.";
                status.style.color = "red";
                playError();
            }
        }

        function completePortalSuccess() {
            const status = document.getElementById('portal-status');
            playSuccess();
            status.innerText = "IDENTITY CONFIRMED.";
            status.style.color = "#0f0";
            
            // Reveal Payload
            setTimeout(() => {
                if(!files.find(f => f.name === 'SECRET_PAYLOAD.script')) {
                    files.push({ icon: 'fa-file-code', color: 'text-red-500', name: 'SECRET_PAYLOAD.script' });
                    renderFiles();
                    printToTerm("> PORTAL BREACHED. PAYLOAD ACQUIRED.", "text-green-500");
                }
            }, 500);
        }

        // --- CONFIG MODAL LOGIC (New) ---
        function openConfigModal() {
            document.getElementById('win-game').classList.add('hidden-el');
            const modal = document.getElementById('password-modal');
            const pinIn = document.getElementById('edit-pin-input');
            const portIn = document.getElementById('edit-portal-input');
            
            pinIn.value = systemPin;
            portIn.value = portalPin;
            
            // Smooth Open
            modal.classList.remove('hidden-el');
            // Force reflow
            void modal.offsetWidth;
            modal.classList.add('modal-visible');
        }

        function saveConfig() {
            const pinIn = document.getElementById('edit-pin-input');
            const portIn = document.getElementById('edit-portal-input');
            
            const newPin = pinIn.value.trim();
            const newPort = portIn.value.trim();
            
            let changed = false;

            if(newPin.length > 0 && newPin.length <= 4 && !isNaN(newPin)) {
                systemPin = newPin;
                document.getElementById('pin-hint').innerText = "HINT: " + systemPin; // Update hint
                changed = true;
            }
            
            if(newPort.length > 0) {
                portalPin = newPort;
                changed = true;
            }

            if(changed) {
                playSuccess();
                printToTerm("> CONFIG UPDATE: CREDENTIALS MODIFIED.", "text-yellow-400");
                
                // Show visual feedback
                const btn = event.target;
                const oldText = btn.innerText;
                btn.innerText = "SAVED!";
                setTimeout(() => btn.innerText = oldText, 1000);
            } else {
                playError();
            }
        }

        function closeConfigModal() {
            const modal = document.getElementById('password-modal');
            modal.classList.remove('modal-visible');

            // Wait for animation to finish before hiding display
            setTimeout(() => {
                modal.classList.add('hidden-el');
                
                const gameWin = document.getElementById('win-game');
                gameWin.classList.remove('hidden-el');
                
                // Logic: Hide secret file & RESET PORTAL
                playBeep(600, 'sawtooth', 0.2);
                files = files.filter(f => f.name !== 'SECRET_PAYLOAD.script');
                renderFiles();
                
                // RESET PORTAL STATE
                const phase1 = document.getElementById('portal-phase-1');
                const phase2 = document.getElementById('portal-phase-2');
                const input = document.getElementById('portal-input');
                const bioBar = document.getElementById('portal-bio-progress');
                const bioStatus = document.getElementById('portal-status');
                
                // Hide Phase 2
                phase2.style.opacity = '0';
                phase2.classList.add('hidden-el');
                
                // Show Phase 1
                phase1.classList.remove('hidden-el');
                phase1.style.pointerEvents = 'auto';
                void phase1.offsetWidth; // Force Reflow
                phase1.style.opacity = '1';
                
                // Clear Values
                input.value = "";
                portalProgress = 0;
                bioBar.style.width = '0%';
                bioStatus.innerText = "";
                
                printToTerm("> SECURE SESSION CLOSED. TEMP FILES REMOVED.");
            }, 300); // Matches CSS transition duration
        }

        // --- DRAG, TERM, CLOCK ---
        function makeDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0; const header = document.getElementById(elmnt.id + "-header");
            if (header) header.onmousedown = (e) => {
                e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY;
                document.querySelectorAll('.window-panel').forEach(w => w.style.zIndex = 10); elmnt.style.zIndex = 50;
                document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
                document.onmousemove = (e) => {
                    e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY;
                    elmnt.style.top = (elmnt.offsetTop - pos2) + "px"; elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                };
            };
        }
        makeDraggable(document.getElementById("win-sys")); makeDraggable(document.getElementById("win-files"));
        makeDraggable(document.getElementById("win-term")); makeDraggable(document.getElementById("win-game"));
        makeDraggable(document.getElementById("browser-stage"));

        const termInput = document.getElementById('term-input'), termOutput = document.getElementById('term-output');
        termInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const val = this.value.trim().toLowerCase(); playBeep(500); printToTerm(`root@sys:~# ${this.value}`, 'text-green-500');
                if (val.startsWith('theme')) {
                    const arg = val.split(' ')[1];
                    if(['red','green','gold'].includes(arg)) { document.body.className = `theme-${arg}`; printToTerm(`> Theme set to ${arg}.`, 'text-blue-400'); }
                    else { document.body.className = ''; printToTerm('> Theme reset to default.', 'text-blue-400'); }
                } else if (val === 'clear') termOutput.innerHTML = '';
                else if (val === 'reboot') location.reload();
                else if (val !== '') printToTerm(`Error: ${val} not found`, 'text-red-500');
                this.value = ''; termOutput.scrollTop = termOutput.scrollHeight;
            }
        });
        function printToTerm(text, className = '') { const div = document.createElement('div'); div.className = className; div.innerText = text; termOutput.appendChild(div); }
        
        function startClock() {
             setInterval(() => { 
                const clock = document.getElementById('clock');
                if(clock) clock.innerText = new Date().toISOString().split('T')[1].split('.')[0]; 
            }, 1000);
        }
        
        function logout() { location.reload(); }

        // --- CONTACT SAVER SOURCE ---
        const contactSaverSource = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>ContactSaver Pro</title><script src="https://cdn.tailwindcss.com"><\/script><script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"><\/script><link href="https://api.fontshare.com/v2/css?f[]=clash-grotesk@200,300,400,500,600,700&f[]=satoshi@300,400,500,700,900&display=swap" rel="stylesheet"><script>tailwind.config={theme:{extend:{fontFamily:{sans:['Satoshi','sans-serif'],clash:['"Clash Grotesk"','sans-serif']},colors:{brand:{50:'#ecfdf5',100:'#d1fae5',200:'#a7f3d0',500:'#10b981',600:'#059669',800:'#065f46',900:'#064e3b',950:'#022c22'},dark:{800:'#1e293b',900:'#0f172a',950:'#020617'}},boxShadow:{'glow':'0 0 20px rgba(16, 185, 129, 0.15)','card':'0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)'}}}}<\/script><style>body{background-color:#f8fafc;background-image:radial-gradient(circle at 50% 0%,#ecfdf5 0%,transparent 70%);font-family:'Satoshi',sans-serif;color:#022c22;-webkit-font-smoothing:antialiased}h1,h2,h3,.font-clash{font-family:'Clash Grotesk',sans-serif;letter-spacing:-0.01em}.glass-header{background:rgba(255,255,255,0.85);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-bottom:1px solid rgba(209,250,229,0.5)}.contact-card{background:white;border:1px solid #e2e8f0;transition:all 0.3s cubic-bezier(0.25,0.8,0.25,1)}.contact-card:hover{transform:translateY(-4px);box-shadow:0 12px 24px -10px rgba(5,150,105,0.15);border-color:#a7f3d0}.grad-1{background:linear-gradient(135deg,#34d399 0%,#059669 100%)}.grad-2{background:linear-gradient(135deg,#a3e635 0%,#16a34a 100%)}.grad-3{background:linear-gradient(135deg,#2dd4bf 0%,#0f766e 100%)}.grad-4{background:linear-gradient(135deg,#064e3b 0%,#065f46 100%)}.hide-scrollbar::-webkit-scrollbar{display:none}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.animate-enter{animation:fadeIn 0.4s ease-out forwards}<\/style><\/head><body class="min-h-screen flex flex-col relative"><nav class="glass-header sticky top-0 z-40 h-16 sm:h-20 transition-all"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full"><div class="flex justify-between items-center h-full"><div class="flex items-center gap-3 cursor-pointer group" onclick="window.location.reload()"><div class="bg-brand-600 text-white w-9 h-9 sm:w-10 sm:h-10 rounded-xl flex items-center justify-center shadow-lg shadow-brand-500/30 group-hover:scale-105 transition-transform duration-300"><i class="fa-solid fa-address-book text-lg"><\/i><\/div><div class="flex flex-col"><span class="text-lg sm:text-xl font-bold text-brand-950 font-clash leading-none">Contact<span class="text-brand-600">Saver<\/span><\/span><span class="text-[9px] sm:text-[10px] text-brand-800/60 font-medium tracking-wider uppercase hidden sm:block">Cloud Directory<\/span><\/div><\/div><div class="flex items-center gap-3"><div class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-brand-50 border border-brand-100 rounded-full"><div id="status-dot" class="w-2 h-2 rounded-full bg-slate-400"><\/div><span id="status-text" class="text-[10px] font-bold uppercase tracking-wider text-brand-900/60">Offline<\/span><\/div><button onclick="openModal()" class="hidden sm:flex bg-brand-950 hover:bg-brand-800 text-white px-5 py-2.5 rounded-xl font-bold transition-all shadow-xl shadow-brand-900/10 items-center gap-2 active:scale-95 font-clash text-sm tracking-wide group"><i class="fa-solid fa-plus transition-transform group-hover:rotate-90"><\/i><span>New Contact<\/span><\/button><button onclick="openModal()" class="sm:hidden w-10 h-10 bg-brand-50 text-brand-600 rounded-xl flex items-center justify-center active:scale-95 active:bg-brand-100 transition-colors"><i class="fa-solid fa-plus text-lg"><\/i><\/button><\/div><\/div><\/div><\/nav><div class="sticky top-16 sm:top-20 z-30 bg-white/80 backdrop-blur-md border-b border-brand-100/60 py-4 transition-all"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><div class="flex flex-col sm:flex-row gap-3"><div class="relative flex-grow group"><div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i class="fa-solid fa-magnifying-glass text-brand-900/30 group-focus-within:text-brand-600 transition-colors"><\/i><\/div><input type="text" id="search-input" placeholder="Search by name, company, or number..." class="w-full bg-brand-50/50 hover:bg-white focus:bg-white border border-brand-100 rounded-2xl py-3 pl-11 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 transition-all font-medium text-brand-900 placeholder-brand-900/30"><\/div><button id="fav-filter-btn" onclick="toggleFavFilter()" class="flex items-center justify-center gap-2 px-5 py-3 rounded-2xl border border-brand-100 bg-white text-brand-900/70 font-bold text-xs uppercase tracking-wider font-clash hover:bg-brand-50 hover:border-brand-200 transition-all active:scale-95 shadow-sm sm:w-auto w-full"><i class="fa-regular fa-star text-base" id="fav-filter-icon"><\/i><span>Favorites<\/span><\/button><\/div><\/div><\/div><main class="flex-grow container mx-auto px-4 py-8 sm:px-6 lg:px-8 max-w-7xl"><div class="flex items-center justify-between mb-6"><h2 class="text-xl sm:text-2xl font-semibold text-brand-950 font-clash">All Contacts <span id="contact-count" class="ml-2 text-sm text-brand-600 font-medium font-sans bg-brand-100 px-2 py-0.5 rounded-md align-middle">0<\/span><\/h2><\/div><div id="contacts-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-24"><div class="col-span-full py-20 flex flex-col items-center justify-center text-brand-300 animate-pulse"><i class="fa-solid fa-circle-notch fa-spin text-3xl mb-3 text-brand-500"><\/i><span class="text-xs font-bold uppercase tracking-widest font-clash">Loading Database...<\/span><\/div><\/div><div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center animate-enter"><div class="w-20 h-20 bg-brand-50 rounded-3xl flex items-center justify-center mb-6 text-brand-300"><i class="fa-solid fa-users-slash text-3xl"><\/i><\/div><h3 class="text-xl font-bold text-brand-950 font-clash">No contacts found<\/h3><p class="text-brand-900/50 text-sm max-w-xs mt-2 mx-auto">Try adjusting your search filters or add a new contact to your directory.<\/p><\/div><\/main><button onclick="openModal()" class="sm:hidden fixed bottom-6 right-6 w-14 h-14 bg-brand-600 text-white rounded-full shadow-2xl shadow-brand-600/40 flex items-center justify-center z-40 active:scale-90 transition-transform"><i class="fa-solid fa-plus text-xl"><\/i><\/button><div id="modal-overlay" class="fixed inset-0 bg-brand-950/60 backdrop-blur-sm z-50 hidden flex items-end sm:items-center justify-center p-0 sm:p-4 opacity-0 transition-opacity duration-300"><div class="bg-white w-full max-w-lg rounded-t-[2rem] sm:rounded-[2rem] shadow-2xl transform translate-y-full sm:translate-y-10 scale-95 transition-all duration-300 max-h-[90vh] overflow-y-auto hide-scrollbar" id="modal-content"><div class="sticky top-0 bg-white/95 backdrop-blur-md z-10 px-6 sm:px-8 py-6 border-b border-brand-50 flex justify-between items-center"><h2 class="text-xl font-bold text-brand-950 font-clash" id="modal-title">New Contact<\/h2><button onclick="closeModal()" class="w-10 h-10 rounded-full bg-brand-50 text-brand-400 hover:bg-brand-100 hover:text-brand-700 flex items-center justify-center transition-colors"><i class="fa-solid fa-xmark text-lg"><\/i><\/button><\/div><form id="contact-form" class="px-6 sm:px-8 py-8 space-y-6"><input type="hidden" id="edit-doc-id"><div class="bg-brand-50 p-1.5 rounded-2xl flex border border-brand-100"><label class="flex-1 cursor-pointer"><input type="radio" name="contactType" value="personal" class="peer sr-only" checked onchange="toggleBusinessFields()"><div class="py-2.5 text-center rounded-xl text-[11px] font-bold uppercase tracking-wider text-brand-400 transition-all peer-checked:bg-white peer-checked:text-brand-600 peer-checked:shadow-sm font-clash">Personal<\/div><\/label><label class="flex-1 cursor-pointer"><input type="radio" name="contactType" value="business" class="peer sr-only" onchange="toggleBusinessFields()"><div class="py-2.5 text-center rounded-xl text-[11px] font-bold uppercase tracking-wider text-brand-400 transition-all peer-checked:bg-white peer-checked:text-brand-600 peer-checked:shadow-sm font-clash">Business<\/div><\/label><\/div><div class="space-y-5"><div class="group"><label class="block text-[10px] font-black uppercase text-brand-300 tracking-widest mb-2 ml-1 font-clash group-focus-within:text-brand-600 transition-colors">Name<\/label><input type="text" id="inp-name" required class="w-full px-5 py-3.5 bg-brand-50/50 border border-brand-100 rounded-2xl focus:bg-white focus:ring-4 focus:ring-brand-500/10 focus:border-brand-500 transition-all outline-none font-semibold text-brand-900 placeholder-brand-200" placeholder="Jane Doe"><\/div><div class="group"><label class="block text-[10px] font-black uppercase text-brand-300 tracking-widest mb-2 ml-1 font-clash group-focus-within:text-brand-600 transition-colors">Phone<\/label><input type="tel" id="inp-number" required class="w-full px-5 py-3.5 bg-brand-50/50 border border-brand-100 rounded-2xl focus:bg-white focus:ring-4 focus:ring-brand-500/10 focus:border-brand-500 transition-all outline-none font-mono font-medium text-brand-900 placeholder-brand-200" placeholder="+1 (555) 000-0000"><\/div><div class="group"><label class="block text-[10px] font-black uppercase text-brand-300 tracking-widest mb-2 ml-1 font-clash group-focus-within:text-brand-600 transition-colors">Location<\/label><input type="text" id="inp-place" class="w-full px-5 py-3.5 bg-brand-50/50 border border-brand-100 rounded-2xl focus:bg-white focus:ring-4 focus:ring-brand-500/10 focus:border-brand-500 transition-all outline-none font-medium text-brand-900 placeholder-brand-200" placeholder="City, Country"><\/div><\/div><div id="business-fields" class="hidden space-y-5 pt-4 border-t border-brand-50 animate-enter"><div class="flex items-center gap-2 text-brand-600 font-bold text-xs uppercase tracking-widest font-clash"><i class="fa-solid fa-briefcase"><\/i> Work Details<\/div><div class="grid grid-cols-2 gap-4"><div class="group"><label class="block text-[10px] font-black uppercase text-brand-300 tracking-widest mb-2 font-clash group-focus-within:text-brand-600 transition-colors">Company<\/label><input type="text" id="inp-company" class="w-full px-4 py-3 bg-brand-50/50 border border-brand-100 rounded-xl focus:bg-white focus:border-brand-500 outline-none text-sm font-semibold text-brand-900"><\/div><div class="group"><label class="block text-[10px] font-black uppercase text-brand-300 tracking-widest mb-2 font-clash group-focus-within:text-brand-600 transition-colors">Role<\/label><input type="text" id="inp-position" class="w-full px-4 py-3 bg-brand-50/50 border border-brand-100 rounded-xl focus:bg-white focus:border-brand-500 outline-none text-sm font-semibold text-brand-900"><\/div><\/div><\/div><div class="pt-4 pb-2"><button type="submit" id="submit-btn" class="w-full bg-brand-950 text-white py-4 rounded-2xl font-bold shadow-xl shadow-brand-900/20 hover:bg-brand-800 transition-all flex justify-center items-center gap-2 font-clash tracking-wide uppercase text-xs active:scale-[0.98]"><span id="submit-btn-text">Save Contact<\/span><\/button><\/div><\/form><\/div><\/div><div id="delete-modal" class="fixed inset-0 bg-brand-950/60 backdrop-blur-md z-[60] hidden items-center justify-center p-4"><div class="bg-white p-8 rounded-[2rem] max-w-sm w-full shadow-2xl text-center transform scale-100 transition-all"><div class="w-16 h-16 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-sm"><i class="fa-solid fa-trash-can text-2xl"><\/i><\/div><h3 class="text-xl font-bold text-brand-950 mb-2 font-clash">Delete Contact?<\/h3><p class="text-brand-900/60 text-sm mb-8 leading-relaxed font-medium">This action cannot be undone. The contact will be removed from the global directory.<\/p><div class="flex gap-3"><button onclick="closeDeleteModal()" class="flex-1 py-3 bg-brand-50 text-brand-700 rounded-xl font-bold hover:bg-brand-100 font-clash tracking-wide text-xs uppercase">Cancel<\/button><button id="confirm-delete-btn" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 font-clash tracking-wide text-xs uppercase shadow-lg shadow-red-500/30">Delete<\/button><\/div><\/div><\/div><div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-[100] transform translate-y-20 opacity-0 transition-all duration-500 bg-brand-950 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 border border-brand-800 pointer-events-none"><i class="fa-solid fa-circle-check text-brand-400"><\/i><span id="toast-msg" class="text-xs font-bold font-clash tracking-wide uppercase">Successful<\/span><\/div><script type="module">import {initializeApp} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import {getAuth,signInAnonymously,onAuthStateChanged} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import {getFirestore,collection,addDoc,onSnapshot,serverTimestamp,query,deleteDoc,updateDoc,doc} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";const firebaseConfig={apiKey:"AIzaSyAa-dboD2E9BtHDCHFiL26R0eUFpYmgJbs",authDomain:"contact-74f93.firebaseapp.com",projectId:"contact-74f93",storageBucket:"contact-74f93.firebasestorage.app",messagingSenderId:"810286094076",appId:"1:810286094076:web:fd974fdcd98e012a31a979",measurementId:"G-QHQ0CM0XNP"};const appId=typeof __app_id!=='undefined'?__app_id:'contact-pro-74f93';const app=initializeApp(firebaseConfig);const auth=getAuth(app);const db=getFirestore(app);let currentUser=null;let allContacts=[];let searchTerm="";let filterFavorites=false;let deleteTargetId=null;const getPublicRef=()=>collection(db,'artifacts',appId,'public','data','contacts');const getPublicDoc=(id)=>doc(db,'artifacts',appId,'public','data','contacts',id);async function authenticate(){try{await signInAnonymously(auth);}catch(err){console.error("Auth error",err);updateStatus(false);}}onAuthStateChanged(auth,(user)=>{if(user){currentUser=user;updateStatus(true);syncDatabase();}else{updateStatus(false);}});function updateStatus(isOnline){const statusEl=document.getElementById('status-text');const dotEl=document.getElementById('status-dot');if(isOnline){statusEl.innerText="Cloud Active";dotEl.className="w-2 h-2 rounded-full bg-brand-500 animate-pulse shadow-[0_0_10px_rgba(16,185,129,0.5)]";}else{statusEl.innerText="Offline";dotEl.className="w-2 h-2 rounded-full bg-red-500";}}function syncDatabase(){onSnapshot(getPublicRef(),(snapshot)=>{allContacts=[];snapshot.forEach(d=>allContacts.push({id:d.id,...d.data()}));allContacts.sort((a,b)=>(a.name||'').localeCompare(b.name||''));renderUI();},(error)=>console.error("Sync error",error));}function renderUI(){const grid=document.getElementById('contacts-grid');const emptyState=document.getElementById('empty-state');const countBadge=document.getElementById('contact-count');if(!grid)return;let filtered=allContacts;if(searchTerm){const s=searchTerm.toLowerCase();filtered=filtered.filter(c=>(c.name||'').toLowerCase().includes(s)||(c.number||'').includes(s)||(c.place||'').toLowerCase().includes(s)||(c.company||'').toLowerCase().includes(s));}if(filterFavorites)filtered=filtered.filter(c=>c.isFavorite);if(countBadge)countBadge.innerText=filtered.length;grid.innerHTML='';if(filtered.length===0){if(emptyState)emptyState.classList.remove('hidden');return;}if(emptyState)emptyState.classList.add('hidden');filtered.forEach((contact,idx)=>{const initial=(contact.name||"?").charAt(0).toUpperCase();const gradClass='grad-'+((idx%4)+1);const isBiz=contact.type==='business';const card=document.createElement('div');card.className="contact-card rounded-[1.5rem] p-6 flex flex-col relative group overflow-hidden animate-enter";card.style.animationDelay=\`\${idx*50}ms\`;card.innerHTML=\`<div class="flex items-start justify-between mb-6"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-2xl \${gradClass} flex items-center justify-center text-white font-bold text-lg shadow-md font-clash">\${initial}</div><div><h3 class="font-bold text-brand-950 leading-tight font-clash text-lg truncate max-w-[140px] sm:max-w-[180px]">\${esc(contact.name)}</h3><p class="text-[10px] font-black uppercase tracking-widest \${isBiz?'text-brand-600':'text-brand-400'} mt-1 font-clash">\${isBiz?'Business':'Personal'}</p></div></div><button onclick="window.toggleFavorite('\${contact.id}', \${contact.isFavorite})" class="transition-all p-2 rounded-xl hover:bg-brand-50 \${contact.isFavorite?'text-amber-400':'text-brand-200 hover:text-amber-400'}"><i class="\${contact.isFavorite?'fa-solid':'fa-regular'} fa-star text-lg"></i></button></div><div class="space-y-3 mb-6"><div class="flex items-center justify-between bg-brand-50/50 p-3 rounded-xl border border-brand-100 group/phone cursor-pointer hover:border-brand-200 hover:bg-brand-50/80 transition-all" onclick="window.copyNumber('\${esc(contact.number)}')"><div class="flex items-center gap-3 overflow-hidden"><i class="fa-solid fa-phone text-xs text-brand-300"></i><span class="font-mono font-bold text-brand-900 text-sm truncate tracking-tight">\${esc(contact.number)}</span></div><i class="fa-regular fa-copy text-[10px] text-brand-300 opacity-0 group-hover/phone:opacity-100 transition-opacity"></i></div>\${contact.place?\`<div class="flex items-center gap-3 px-3"><i class="fa-solid fa-location-dot text-[10px] text-brand-300"></i><span class="text-xs font-bold text-brand-800 truncate font-clash tracking-wide">\${esc(contact.place)}</span></div>\`:''}\${isBiz?\`<div class="pt-4 mt-1 border-t border-brand-50 space-y-1.5 px-1"><div class="flex items-center gap-2 text-[10px] font-bold text-brand-400 uppercase tracking-tight font-clash"><i class="fa-solid fa-building text-[9px] text-brand-300"></i> \${esc(contact.company||'N/A')}</div><div class="flex items-center gap-2 text-[10px] font-bold text-brand-400 uppercase tracking-tight font-clash"><i class="fa-solid fa-user-tag text-[9px] text-brand-300"></i> \${esc(contact.position||'N/A')}</div></div>\`:''}</div><div class="flex gap-2 mt-auto pt-4 border-t border-brand-50"><button onclick="window.openEditModal('\${contact.id}')" class="flex-1 py-2.5 text-[10px] font-black uppercase tracking-widest text-brand-400 hover:text-brand-600 hover:bg-brand-50 rounded-lg transition-all flex items-center justify-center gap-1.5 font-clash border border-transparent hover:border-brand-100"><i class="fa-solid fa-pen"></i> Edit</button><button onclick="window.confirmDelete('\${contact.id}')" class="flex-1 py-2.5 text-[10px] font-black uppercase tracking-widest text-brand-300 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all flex items-center justify-center gap-1.5 font-clash border border-transparent hover:border-red-100"><i class="fa-solid fa-trash-can"></i> Del</button></div>\`;grid.appendChild(card);});}window.toggleFavFilter=()=>{filterFavorites=!filterFavorites;const btn=document.getElementById('fav-filter-btn');const icon=document.getElementById('fav-filter-icon');if(!btn||!icon)return;if(filterFavorites){btn.classList.add('bg-brand-950','text-white','border-brand-950');btn.classList.remove('bg-white','text-brand-600','border-brand-100');icon.classList.remove('fa-regular');icon.classList.add('fa-solid');}else{btn.classList.remove('bg-brand-950','text-white','border-brand-950');btn.classList.add('bg-white','text-brand-600','border-brand-100');icon.classList.remove('fa-solid');icon.classList.add('fa-regular');}renderUI();};const searchInput=document.getElementById('search-input');if(searchInput){searchInput.addEventListener('input',(e)=>{searchTerm=e.target.value.trim();renderUI();});}window.openModal=()=>{const form=document.getElementById('contact-form');if(form)form.reset();document.getElementById('edit-doc-id').value="";document.getElementById('modal-title').innerText="New Contact";const sBtn=document.getElementById('submit-btn');if(sBtn)sBtn.innerHTML='<span id="submit-btn-text">Save Contact<\/span>';document.querySelector('input[value="personal"]').checked=true;toggleBusinessFields();const overlay=document.getElementById('modal-overlay');const content=document.getElementById('modal-content');overlay.classList.remove('hidden');requestAnimationFrame(()=>{overlay.classList.remove('opacity-0');content.classList.remove('translate-y-full','scale-95');content.classList.add('translate-y-0','scale-100');});};window.closeModal=()=>{const overlay=document.getElementById('modal-overlay');const content=document.getElementById('modal-content');overlay.classList.add('opacity-0');content.classList.add('translate-y-full','scale-95');content.classList.remove('translate-y-0','scale-100');setTimeout(()=>{overlay.classList.add('hidden');},300);};window.toggleBusinessFields=()=>{const type=document.querySelector('input[name="contactType"]:checked').value;const fields=document.getElementById('business-fields');if(type==='business'){fields.classList.remove('hidden');}else{fields.classList.add('hidden');}};document.getElementById('contact-form').addEventListener('submit',async(e)=>{e.preventDefault();if(!currentUser)return;const docId=document.getElementById('edit-doc-id').value;const type=document.querySelector('input[name="contactType"]:checked').value;const btn=document.getElementById('submit-btn');const name=document.getElementById('inp-name').value.trim();const number=document.getElementById('inp-number').value.trim();const place=document.getElementById('inp-place').value.trim();const data={name,number,place,type,updatedAt:serverTimestamp()};if(type==='business'){data.company=document.getElementById('inp-company').value.trim();data.position=document.getElementById('inp-position').value.trim();}else{data.company="";data.position="";}btn.disabled=true;btn.innerHTML='<i class="fa-solid fa-circle-notch fa-spin"><\/i> Processing...';try{if(docId){await updateDoc(getPublicDoc(docId),data);showToast("UPDATED SUCCESSFULLY");}else{await addDoc(getPublicRef(),{...data,isFavorite:false,createdAt:serverTimestamp(),createdBy:currentUser.uid});showToast("ADDED SUCCESSFULLY");}closeModal();}catch(err){console.error(err);showToast("OPERATION FAILED");}finally{btn.disabled=false;}});window.openEditModal=(id)=>{const contact = allContacts.find(c => c.id === id); if(!contact) return; document.getElementById('edit-doc-id').value=contact.id;document.getElementById('inp-name').value=contact.name||'';document.getElementById('inp-number').value=contact.number||'';document.getElementById('inp-place').value=contact.place||'';const radio=document.querySelector(\`input[name="contactType"][value="\${contact.type}"]\`);if(radio)radio.checked=true;if(contact.type==='business'){document.getElementById('inp-company').value=contact.company||'';document.getElementById('inp-position').value=contact.position||'';}document.getElementById('modal-title').innerText="Edit Contact";document.getElementById('submit-btn').innerHTML='<span id="submit-btn-text">Update Contact<\/span>';toggleBusinessFields();const overlay=document.getElementById('modal-overlay');const content=document.getElementById('modal-content');overlay.classList.remove('hidden');requestAnimationFrame(()=>{overlay.classList.remove('opacity-0');content.classList.remove('translate-y-full','scale-95');content.classList.add('translate-y-0','scale-100');});};window.toggleFavorite=async(id,currentStatus)=>{if(!currentUser)return;try{await updateDoc(getPublicDoc(id),{isFavorite:!currentStatus});}catch(e){console.error(e);}};window.confirmDelete=(id)=>{deleteTargetId=id;document.getElementById('delete-modal').classList.remove('hidden');document.getElementById('delete-modal').classList.add('flex');};window.closeDeleteModal=()=>{document.getElementById('delete-modal').classList.add('hidden');document.getElementById('delete-modal').classList.remove('flex');deleteTargetId=null;};document.getElementById('confirm-delete-btn').addEventListener('click',async()=>{if(!currentUser||!deleteTargetId)return;try{await deleteDoc(getPublicDoc(deleteTargetId));showToast("CONTACT DELETED");}catch(e){console.error(e);}closeDeleteModal();});window.copyNumber=(num)=>{const area=document.createElement('textarea');area.value=num;document.body.appendChild(area);area.select();document.execCommand('copy');document.body.removeChild(area);showToast("COPIED NUMBER");};function showToast(msg){const t=document.getElementById('toast');const m=document.getElementById('toast-msg');m.innerText=msg;t.classList.remove('translate-y-20','opacity-0');setTimeout(()=>t.classList.add('translate-y-20','opacity-0'),3000);}function esc(t){return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):"";}authenticate();window.toggleBusinessFields=toggleBusinessFields;<\/script><\/body><\/html>`;
    </script>
</body>
</html>